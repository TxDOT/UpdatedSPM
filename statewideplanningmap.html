<!DOCTYPE html>
<!-- This work is licensed under the Creative Commons Attribution-ShareAlike 4.0 International License. To view a copy of this license, visit https://creativecommons.org/licenses/by-sa/4.0/ -->
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
        <title>TxDOT - Statewide Planning Map</title>
        <link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/light/main.css">
        <script src="https://js.arcgis.com/4.26/"></script>         
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');
            @media (max-width: 480px){
              #left-div{
                display: none;
                z-index: 2 !important;

              }
              .hamburgler{
                display: block !important;
              }
              #viewDiv{
                width: calc(100vw - 0px) !important;
                left: 0px !important;
              }
              #queryMessageBtn{
                margin-left:  16.6rem !important;
              }
              #diagramTab, #roadwayDiagram{
                display: none !important;
              }
            }
            @media (min-width: 481px) and (max-width: 767px){
              #left-div{
                display: block !important;
              }
              #serviceDownDiv{
                transform: translate(-4rem, 50%) !important;
              }
            }
            @media (min-width: 768px) and (max-width: 1024px){
              #left-div{
                display: block !important;
              }
              #queryMessageBtn{
                margin-left:  15.6rem !important;
              }
            }
            @media (min-width: 1025px) and (max-width: 1280px){
              #left-div{
                display: block !important;
              }
            }
            @media (min-width: 1281px){
              #left-div{
                display: block !important;
              }
            }
            html{
              scroll-behavior: smooth;
            }
            #printWidget{
              position:relative;
              top: 5rem;
            }
            .queryStatus{
              display: flex;
              flex-wrap: wrap;
              background-color: rgba(245, 245, 245, 1);
              position: relative;
              z-index: 1;
              max-width: 24%;
              left: calc(50vw - 11rem);
              top: 4vh;
              min-width: 23rem;
              width: fit-content;
              overflow-y: auto;
              max-height: calc(100vh - 6rem);
              align-items: flex-start;
            }
            .stepClass{
              display: flex;
              position:relative;
              top:.6rem;
              background-color: white;
              color: black;
              padding-left: .5rem;
              font-size: 15px;
              width: 18rem;
              right: 1rem;
              padding-top: .5rem;
              padding-bottom: .5rem;
            }
            .underline::after{
              content: "";
              width:44px;
              padding-top: 21px;
              border-bottom: 3px solid #14375A;
              position: absolute
            }

            #closeAbout{
              font-size: small;
              text-decoration: underline;
              color:#14375A;
            }
            #serviceDownDiv{
              position: fixed;
              z-index: 1;
              left:50%;
              transform: translate(-30%, -50%);
              top: 4rem;
              width: calc(100%-20%);
              font-family: Roboto, Avenir, Helvetica, Arial, sans-serif !important;
              height: 1.5rem;
              color: white;
              padding: .5rem;
              text-align: center;
              display: flex;
            }

            #graphics{
              top: 0rem;
              position: relative;
              max-height: 7rem;
              overflow-y: auto;
              scrollbar-width: none;
            }
            #graphics::-webkit-scrollbar{
              display: none;
            }
            .queryStatus #queryMessageBtn{
              position:relative;
              z-index: 1;
              margin-top: 1.3rem;
              margin-bottom: 1rem;
              margin-left: calc(24vw - 5.8rem);
              right: -1rem;
            }
            #copyCoord{
              position: relative;
              z-index: 1;
              margin-top: -3rem;
              margin-right: calc(24vw - 6rem);
              left: 1.4rem;
            }
            #copyURL{
              position: relative;
              z-index: 1;
              margin-top: -3rem;
              margin-right: calc(24vw - 6rem);
              visibility: hidden;
              left: 6.5rem;
            }
            .esri-icon-notice-triangle{
              font-family: Roboto, Avenir, Helvetica, Arial, sans-serif !important;
            }
            .esri-print__advanced-options-section{
              display: none;
            }
            #queryMessagePara{
              font-size: 1rem;
              padding-left: 1.5rem;
              padding-right: 1.5rem;
              text-align: left;
            }
            .main{
              font-family: Roboto, Avenir, Helvetica, Arial, sans-serif !important;
              color:black !important;
              letter-spacing: .0008em;
              font-weight: 400;
              line-height: 1.375rem;
              user-select: none;
            }
            .dwnloadBtn{
              position: absolute;
              left: 83%;
              padding-top: .3rem;
              background: none;
              background-color: none;
              cursor: pointer;
              border: none;
            }
            .dwnloadBtn button{
              display: "none";
            }
            .noDwnloadBtn{
              position:absolute;
              left: 83%;
              padding-top: .3rem;
              background: none;
              background-color: none;
              cursor: default;
              border: none;
              color: grey;
              
            }
            .dwnloadBtn:hover{
              color: green;
            }

            .invisible{
              visibility: hidden;
            }
            .esri-icon-collapse{
              rotate: 90deg;
              position: absolute;
              top: 20rem;
              left: 15rem;
            }
            #expandPopup{
              position: absolute;
              right: 3rem;
            }
            #header {
                height: 40px;
                width: 100%;
                background-color: rgb(20, 55, 90);
                display: flex;
                justify-content: space-between;
                align-items: center;
                color: white;
            }
            .logo {
                font-size: 17px;
                font-weight: 600;
                letter-spacing: .01rem;
            }      
            a[class="links"]{
              position: relative;
              color: white;
              font-size: 14px;
              text-decoration: none;
              top: .4rem;
              padding-left: 2px;
            }

            a:hover{
              cursor: pointer;
            }

            #left-div {
                position: absolute;
                left: 0px;
                top: 40px;
                width: 300px;
                height: calc(100vh - 40px);
                background-color: white;
                overflow-y: auto;
                overflow-x: hidden;
                scrollbar-width: thin;
            }

            #left-div::-webkit-scrollbar {
              width: 1px;
            }       
            #viewDiv {
                position: absolute;
                top: 40px;
                left: 300px;
                height: calc(100vh - 40px);
                width: calc(100vw - 300px);
                float: left;
                background-color: white;
                z-index: 1;
                scroll-behavior: smooth;
            }
            .textArea{
              position: relative;
              border: .15rem solid rgba(70,130,180,.5);
              height: 3rem;
              bottom: .5rem;
              width: 2rem;
              left: 1rem;
            }
            .textArea:hover{
              cursor: pointer
            }
            #previewUrl{
              width: calc(24vw - 4.1rem);
              height: fit-content;
              resize: none;
              border: .12rem solid #204e70;
              text-align: left;
              padding-left: 10px;
              margin-left: 1.5rem;
              overflow-wrap: break-word;
              margin-right: 18px;
              padding-right: 10px;
            }
            #previewBtn{
              position: relative;
              left: .7rem;
              bottom: .3rem;
            }
            .esri-view .esri-view-surface--inset-outline:focus::after {outline: none !important;}    
            .esri-view .esri-zoom.esri-widget {
              position: absolute;
              top: 45px;
            }         
            .esri-scale-bar {
              position: absolute;
              bottom: 20px;
              left: 15;
            }          
            .toolsContainer {
              position: absolute;
              top: 15px;
              right: 12px;
              display: flex;
              flex-direction: column;
              align-items: center;
              z-index: 1;
            }
            .toolsChild {
              background-color: white;
              margin-left: 0px;
              margin-right: 3px;
              margin-bottom: 10px;
              padding: 8px;
              border-radius: 0px;
              box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
              cursor: pointer;
            }

            .spmMainBtn{
              font-family: inherit;
              outline: #14375A;
              background: none;
              color: white;
              cursor: pointer;
              background-color: rgba(32, 78, 112, 0.8);
              border: none;
              height: 2rem;
              width: fit-content;
              margin-right: 1rem;
              padding-left: .5rem;
              padding-right: .5rem;
            }
            .spmMainBtn:disabled{
              background-color: lightgray;
              cursor: default;
              color: gray;
              border: 2px lightgray solid;
              height: 2rem;
              width: fit-content;
              pointer-events: none;
            }
            .spmMainBtn:active{
              background: rgba(20,55,90,.5);
            }
            .spmMainBtn:hover{
              background: rgb(20, 55, 90);
            }
            .spmSecondaryBtn{ 
              background: none;
              cursor: pointer;
              border: 1px #14375A solid;
              background-color: none;
              font-family: inherit;;
              height: 2rem;
              color: #204e70;
              margin-right: .9rem;
              padding-left: .5rem;
              padding-right: .5rem;
            }
                
            #lrsOutputTable{
              border-radius: 0px;
              font-size: 13px;
            }
            .spmSecondaryBtn:disabled{
              outline: #888;
              background-color: lightgray;
              border: 2px solid lightgray;
              cursor: default;
              height: 2rem;
              pointer-events: none;
              color: gray
            }
            .spmSecondaryBtn:active{
              background: rgba(20,55,90,.5);
            }
            .spmSecondaryBtn:hover{
              color: white;
              background-color: rgba(32, 78, 112, 0.8)
            }
            .spmDropDown{
              border: 1px solid #14375A;
              background: none;
              border-radius: 0px;
              top: 0rem;
              position: relative;
            }

            .spmDropDown:disabled{
              border: 1px solid #888;
              color:#888;
              outline: #888
            }
            #modalHeader{
              bottom: 1.6rem;
              color: white;
              background-color: #14375A;
              text-align: left;
              padding-left: 0rem;
              padding-right: 0rem;
              padding-top: .6rem;
              height: 2rem;
              width: 100%;
              right: .6rem;
              text-transform: uppercase;
              margin-top: 0rem;
              font-size: 15px;
              text-indent: 1.4rem;
            }
            .notes{
              display: none;
              overflow: hidden;
            }
            .expandNotes:active .notes{
              display:block
            }
            #marginal {
                position: absolute;
                bottom: 12px;
                left: 12px;
                background-color: white;
                padding: 5px;
                border-radius: 5px;
                box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
                z-index: 1; 
                font-size: calc(9px + 0.390625vw);
            }      
            #mapClickResults {
                position: absolute;
                bottom: 12px;
                right: 12px;
                background-color: white;
                padding: 5px;
                border-radius: 5px;
                box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
                z-index: 1; 
                font-size: calc(9px + 0.390625vw);
            }         
            .tabsContainer {
              position: relative;
              top: 8px;
              right: 0px;
              width: 300px;
              display: flex;
              justify-content: center;
              align-items: center;
              z-index: 1;
            }
            .tabsChild {
              position: relative;
              bottom: 1.2rem;
              margin-left: 1px;
              padding: 5px;
              cursor: pointer;
              text-transform: uppercase;
              font-size: 15px;
              padding-top: 1.3rem;
              padding-bottom: .7rem;
              z-index: 1;
              width: 3.03rem;
              display: flex;
              justify-content: center;
            }
            body {
                margin: 0;
                padding: 0;
            }
            nav {
                position: relative;
                right: 0px;
                bottom: 6px;
            }
            #resetMap {
              position: absolute;
              top: 134px;
              left: 16px;
            }
            .hamburgler{
              position: absolute;
              top: 180px;
              left: 16px;
              display: none;
              border: none;
            }
            #rmvDiv{
              position: absolute;
              left: 83%;
              padding-top: .2rem;
              background: none;
              cursor: pointer;
              border: none;
            }

            .removeOverlay{
              position: relative;
              top: 0.02rem;
              left: 83%;
              background: none;
              cursor: pointer;
              border: none;
            }

            .removeOverlay:hover{
              color: red;
            }
            .rmvQueryBtn{
              position: relative;
              top: 0.02rem;
              left: 83%;
              background: none;
              cursor: pointer;
              border: none;
              margin-right: -1rem
            }
            .popupDivPosition{
              position:absolute;
              width: 6rem;
              height: 1.5rem;
              background-color: rgba(20, 55, 90, .8);
              color: white;
              visibility: hidden;
              left: 10.5rem;
              padding-left: .2rem;
            }

            .rmvQueryBtn:hover{
              color: red;
            }
            /* .planLabel{

            } */
            #searchTool {
              position: absolute;
              top: 15px;
              left: 13px;
              background-color: white;
              margin-left: 3px;
              margin-right: 3px;
              padding: 8px;
              border-radius: 0px;
              box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
              cursor: pointer;
            }
            #searchBox{
              position: relative;
              top: 0rem;
              left: 3rem;
            }
            #searchBox input{
              width: 100% !important;
              padding: 0px !important;
              border: 0px solid #ccc !important;
              resize: both !important;
              margin-bottom: 0px !important;
            }
            tr:nth-child(odd) {background-color: #ffffff;}
            tr:nth-child(even) {background-color: #f2f2f2;}
            th {text-align: left;}    

            #exportSpan {
              cursor: pointer;
              color: blue;
              font-size: 13px;
            }
            .tocTabs {
              position: absolute;
              top: 44px;
              left: 0px;
              width: 300px;
            }
            .tocTabsQuery, .tocTabsSketch, .tocTabsEvent, .tocTabsDiagram {
              position: absolute;
              top: 50px;
              left: 18px;
              width: 270px;
            } 
            .eventTabInput {
              width: 80%;
            }
            #tocMaps {
              width: 300px;
              cursor: pointer;
              font-size: 13px;
            }
            #addFeatRow{
              position: relative;
              bottom: .5rem;
            }
            .basemapHeader {
              color: white;
              background-color: #204e70;
              text-align: left;
              padding-left: .3rem;
              font-size: 15px;
              font-weight: normal;
            }
            .baseMapList {
              color: black;
              font-weight: normal;
              padding-left: 1rem;
            }
            #mapTab,#queryTab,#diagramTab,#eventTab,#sketchTab {
              display: none;
            }
            select:focus{
              outline: 1px #204e70 solid;
            }
            select:disabled{
              cursor: default;
              border:1px solid gray;
            }
            input[type=text], select, textarea {
              width: 97%;
              padding: 10px;
              border: 1px solid #14375A;
              resize: vertical;
              margin-bottom: 15px;
            }    
            input[type=number] {
              width: 89%;
              padding: 10px;
              border: 1px solid #14375A;
              resize: vertical;
              margin-bottom: 15px;              
            }
            input:invalid{
              border: 2px solid red;
            }

            input:disabled{
              border: 1px solid #888;
              color: #888;
            }
            input:focus{
              outline: 1px #204e70 solid;
            }
            tr:hover{
              background-color: rgba(32, 78, 112, .4);
              cursor: pointer;
              border: 1px solid black;
            }
            .graphSpan{
              font-size: 12px;
              display:flex;
              width: 87%;
              padding-left: .3rem;
              padding-right: 1rem;
              background-color: #ccc;
            }
            .containerDiv{
              display: flex;
              margin-bottom: 3px;
              width: 19.81rem;
            }
            #graphDiv{
              position: relative;
              right: 1.5rem;
              top:0.2rem;
              margin-right: 2.46rem;
            }
            #graphDiv:hover{
              color: red;
              cursor: pointer;
            }
            .dropDown{
              position: relative;
              display: block;
              overflow: hidden;
              width: 19rem;
            }

            #errorEvent{
              width: 97%;
              font-size: 1rem;
              color: white;
              background-color:#14375A;
              box-sizing: border-box;
              display: inline-block;
              text-align: center;
              position: relative;
            }

            #errorSrd{
              width: 97%;
              font-size: 1rem;
              color: white;
              background-color:#14375A;
              box-sizing: border-box;
              display: inline-block;
              text-align: center;
              position: relative;
              top:3rem;
            }
            .error:active{
              padding: 2rem !important;
            }
            #value,#eventDescription,#eventRoute,#inpSRDRouteID,#inpSRDFromDFO,#inpSRDToDFO {
                width: 89%;
            }
            #value{
              position: relative;
              top: 0.4rem;
            }
            #btnAddCondition,#btnUpdateLRM,#btnDiagramGenerateURL, #btnRunQuery,#btnEventMap, #btnInventoryUpdateLRM {
                width: 97%;
            }   
            .esriIcons{
              right: .4rem;
              position: relative;
            }
            .btnRunOpt{
              position:relative;
              right: 0rem;
              bottom:3rem;
            }

            #btnRunQuery:disabled{
              pointer-events: none;
            }
            .btnAddCondition{
              position: relative;
              top: 0.4rem;
              left: 0rem;
              width: 1rem
            }
            .btnClearConditions{
              position: relative;
              left: 0rem;
              
            }
            #btnClearDiagramView{
              left: 8.5rem !important;
              width: 7.9rem;
            }
            #btnToggleTableView{
              position: relative;
              bottom: 1.96rem;
              right: 7rem;
              margin-left: 7rem;
              width: 8rem;
            }
            #btnClearConditions{
              width: 7.7rem;
              left: 8.6rem !important;
              top: .04rem;
            }
            #btnExportToKML{
              position: relative;
              bottom:2rem;
            }
            #btnGenerateURL{
              position: relative;
              left: 8.5rem;
            }
            #btnExportJPEG{
              position: relative;
              bottom: 2rem;
              left: 8.5rem;
            }
            #btnRemoveLast{
              position: relative;
              top: .6rem;
              left: 0rem;
              width: 97%;
            }
            #btnRemoveAll{
              margin-bottom: 1.2rem;
              top: 2.7rem;
              width: 16.4rem;
            }
            #btnInventoryUpdateLRM{
              top: 0rem;
            }
            #btnQueryGenerateURL{
              width: 7.6rem !important;
              left: 8.6rem !important;
              bottom: 2rem;
              position:relative;
            }
            .classRowDiv{
              top:1.2rem;
              position: relative;
              height: 3rem;
            }
            #btnExportToCSV{
              position: relative;
              right: 0rem;
              width: 8rem !important;
            }
            .exportBtn{
              width: 7.9rem !important;
            }
            #btnDiagramGenerateURL{
              width: 97% !important;
              position: relative;
              bottom: 1.4rem;
              left: 0rem;
            }
            #btnToggleDiagramView{
              position: relative;
              right: 7rem;
              bottom: 2rem;
              margin-left: 7rem;
              width:7.9rem;
            }
            #btnUpdateLRM{
              position: relative;
              margin-bottom: 0.5rem !important;
              top: 0rem !important;
              margin-top: -1rem !important;
            }
            #txtPrjLanes{
              margin-top: 0px;
            }
            #results {
                position: absolute;
                left: 70px;
                right: 55px;
                bottom: calc(13vh - 0rem);
                background-color: #F8F8F8;
                display: none;
                overflow: auto;
                height: 30rem;
                border: 1px solid black;
            }
            #parentCanvas {
                position: absolute;
                top: 25px;
                left: 70px;
                right: 55px;
                bottom: 95px;
                background-color: #F8F8F8;
                display: none;
                overflow: hidden;
            }   
            .tabDesc{
              font-size: 13px;
              position: relative;
              bottom: .3rem;
            }
            .borderLine{
              content: "";
              width:18.1rem;
              padding-top: 21px;
              border-top: 1px solid grey;
              position: absolute;
              top: -1.5rem;
              right: -0.16rem;
            }    
            .queryTblData {
                border: 1px solid #F8F8F8;
                padding: 8px;
                text-align: left;
            }
            .queryTblHeader {
                border: 1px solid #F8F8F8;
                padding: 8px;
                text-align: left;              
                background-color: #14375A;
                color: white;
                font-weight: bold;
    	          cursor: pointer;
            }      
            .queryTableResults {
                border-collapse: collapse;
                width: 100%;
            }
            .cellHighlight{
              background-color: rgba(32, 78, 112, .4);
            }
            .queryBuilder{
              position: absolute;
            }
            .queryCondition{
              position: relative;
              display: flex;
              background-color: #ccc;
              padding-left: 1rem;
              font-size: 13px;
              right: 1.6rem;
              margin-bottom: .2rem;
            }
            #operatorBuilder{
              left: 7.5rem;
              top: 0%;
              width: fit-content;
            }
            #operator{
             top: .4rem;
            }
            #fieldBuilder{
              width: 4rem;
              word-wrap: break-word;
            }

            #field{
              top: .5rem;
            }
            #valueBuilder{
              left: 11rem;
              top: 0%;
              width: fit-content;
            }
            .modal {
        			display: none;
        			position: fixed;
        			z-index: 1;
        			left: 0;
        			top: 0;
        			width: 100%;
        			height: 100%;
        			overflow: auto;
        			background-color: rgba(0, 0, 0, 0.4);
        		}
        		.modal-content {
        			background-color: #fefefe;
        			margin: 15% auto;
        			border: 1px solid #888;
        			width: 30rem;
        			border-radius: 0px;
              position: relative;
        		}
            .overlay{
              position: fixed;
              top: 0;
              bottom: 0;
              left: 0;
              right: 0;
              width: 100%;
              height: 100%;
              background: rgba(0, 0, 0, 0.5);
              z-index: 1;
            }
        		#spnClose {
              position: relative;
              bottom: .5rem;
              left: 23.5rem;
        		}
            #startDrawing{
              position: relative;
              left: 10.1rem;
            }
            #btnClearProject{
              position: relative;
              left: 0rem;
              top: .3rem;
              width: 7.6rem;
            }
            #btnRecalcProject{
              position:relative;
              left: 8.7rem;
              width: 7.6rem;
              bottom: 1.7rem;
            }
            #deCostResult{
              font-size: 13px;
              position: relative;
              top: .5rem;
            }
        </style>
        <script>
            var view;
            var map;
            var txdotLayer;
            let backupTxdotLayer;
            var roadwayInventoryfeatureLayer;
            var lightGrayLayer;
            var darkGrayLayer;
            var imageryLayer;
            let itemArr = []
            var streetsLayer;  
            var featureLayer;
            var featureLayerView;
            var theQuery="";
            var queryTask;
            var query;  
            var lrsButtonStatus=false;
            var graphicsLayer;
            var graphicsLayerLRSIdentify;
            let bridgeInventoryFieldsArray = []
            let basemapAll;
            let queryTableResults;
            let draw;
            
            // URL Parameters
            var urlParams;
            var basemapParam;
            var overlayParam;
            var tabParam;
            var locationParam;
            var eventParam;
            var pointParam;
            var queryParam;
            var diagramParam;
            
            //Query Form
            let conditions = [];
            
            //For drawing custom lines
            var linePoints = [];
            var lineGraphic;
            var userDrawnSketchLength=0;
            
            //Simplified Roadway Diagram
            var rulerY; // Vertical position of the ruler
            var rulerHeight; // Height of the ruler
            var rulerMargin; // Margin from left and right borders
            var rulerLength; // Length of the ruler in miles  
            var rulerWidth;
            var pixelsPerMile;
            var labelY; // Y position for upper labels
            var labelPositions; // X positions for upper labels
            var labelFactor;
            var labelValue;            
            var maxAttributesOnPage=0;
            var numberOfAttributes=0;
            var attributeStartY=210;
            var spacePerAttribute=65;
            var csNBR;
            var beginMPT;  
            var diagramCSBegin;
            var diagramCSEnd;
            var diagramTitle;
            var diagramBeginDFO;
            var diagramEndDFO;   
            var inventoryDiagramLog = [];
            var inventoryDiagramLogAllValues = [];
            var drawMPTLabels = true;
            
            var diagramColors = [
            ["#CB4335","#F5B7B1"],["#884EA0","#D7BDE2"],["#2E86C1","#85C1E9"],["#28B463","#82E0AA"],["#D4AC0D","#F7DC6F"],["#BA4A00","#E59866"],["#839192","#BFC9CA"],
            ["#CB4335","#F5B7B1"],["#884EA0","#D7BDE2"],["#2E86C1","#85C1E9"],["#28B463","#82E0AA"],["#D4AC0D","#F7DC6F"],["#BA4A00","#E59866"],["#839192","#BFC9CA"],
            ["#CB4335","#F5B7B1"],["#884EA0","#D7BDE2"],["#2E86C1","#85C1E9"],["#28B463","#82E0AA"],["#D4AC0D","#F7DC6F"],["#BA4A00","#E59866"],["#839192","#BFC9CA"],
            ["#CB4335","#F5B7B1"],["#884EA0","#D7BDE2"],["#2E86C1","#85C1E9"],["#28B463","#82E0AA"],["#D4AC0D","#F7DC6F"],["#BA4A00","#E59866"],["#839192","#BFC9CA"]
            ];

            let mainTOCLayers = ["AADT", "Bridges", "Control Sections", "Functional Classification & Urban Areas", "Maintenance Section Boundaries",
                                 "Reference Markers", "Top 100 Congested Roadways", "Tolls", "National Highway System", "Alt Fuels - Electric", "Hurricane Evacuation Routes", "Metropolitan Planning Organizations", "Live Traffic"]

            let displayPopupInfo = [{}]
            
            //Basemap URLs
            var tileLayerTxDOT = "https://tiles.arcgis.com/tiles/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Vector_Tile_Basemap/VectorTileServer";
            var tileLayerLightGray = "https://www.arcgis.com/sharing/rest/content/items/507a9905e7154ce484617c7327ee8bc4/resources/styles/root.json";
            var tileLayerDarkGray = "https://www.arcgis.com/sharing/rest/content/items/4bd376c56f314bc5a36446630db604a6/resources/styles/root.json";
            var tileLayerStreets = "https://basemaps.arcgis.com/arcgis/rest/services/World_Basemap_v2/VectorTileServer";            
            
            require([
              "esri/Map",
              "esri/views/MapView",
              "esri/layers/FeatureLayer",
              "esri/rest/support/Query",
              "esri/PopupTemplate",
              "esri/geometry/Point",
              "esri/geometry/SpatialReference",
              "esri/layers/TileLayer",
              "esri/views/layers/FeatureLayerView",
              "esri/layers/VectorTileLayer",
              "esri/widgets/ScaleBar",
              "esri/widgets/DistanceMeasurement2D",
              "esri/request",
              "esri/layers/GraphicsLayer",
              "esri/Graphic",
              "esri/Basemap",
              "esri/geometry/Polyline",
              "esri/geometry/geometryEngine",
              "esri/geometry/support/webMercatorUtils",
              "esri/symbols/SimpleLineSymbol",
              "esri/layers/OpenStreetMapLayer",
              "esri/widgets/Search",
              "esri/layers/SubtypeGroupLayer",
              "esri/widgets/Legend",
              "esri/layers/WebTileLayer",
              "esri/layers/WMTSLayer",
              "esri/widgets/Print",
              "esri/widgets/Print/PrintViewModel",
              "esri/widgets/Expand",
              "esri/widgets/Popup",
              "esri/layers/support/LabelClass",
              "esri/core/reactiveUtils",
              "esri/popup/ExpressionInfo"
            ], function(Map,MapView,FeatureLayer,Query,PopupTemplate,Point,SpatialReference,TileLayer,FeatureLayerView,VectorTileLayer,ScaleBar,DistanceMeasurement2D,
                        request,GraphicsLayer,Graphic,Basemap,Polyline,geometryEngine,webMercatorUtils,SimpleLineSymbol, OpenStreetMapLayer, Search, SubtypeGroupLayer, 
                        Legend, WebTileLayer, WMTSLayer, Print, PrintVM, Expand, Popup, LabelClass, reactiveUtils, ExpressionInfo) {
              
              var map = new Map({
                  //map content added below
              });

              //load toc feature layer
              let tocFeatureLayer = new FeatureLayer({
                url: "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/SPM_TOC_Layers_Updated/FeatureServer/0"
              })
              
              let popupArcadeDefinition = {
                "sum numbers" : "SUM([$feature.ev_dc_fast_num, $feature.ev_level1_evse_num, $feature.ev_level2_evse_num])",
                "outsideShoulderText": `DECODE($feature.S_TYPE_O, 2, "Paved", "Unpaved")`,
                "costTruck": "Text(ROUND(($feature.COST_TRK/1000000),2), '$###.### Million')",
                "surfTypeText": `DECODE($feature.SRF_TYPE, 1, "Unpaved", 99, "Unknown", "Paved")`,
                "pedBorderBool": `DECODE($feature.PED, 1, "Yes", 0, "No", "NA")`,
                "commBorderBool": `DECODE($feature.VEH_COML, 1, "Yes", 0, "No", "NA")`,
                "carBorderBool": `DECODE($feature.VEH_CAR, 1, "Yes", 0, "No", "NA")`,
                "bridgeBorderBool": `DECODE($feature.RR_BRDGE, 1, "Yes", 0, "No", "NA")`,
                "tollBorderBool": `DECODE($feature.TOLL_BRDGE, 1, "Yes", 0, "No", "NA")`,
                "uzaDescription": `DECODE($feature.UZA_TYPE, "SUA", "Small Urban (Population 5,000 – 49,999)", "UA", "Urbanized (Population 50,000 – 199,999)", "LUA", "Large Urbanized (Population 200,000+)", "NA")`,
              }
              //load startup function
              const getURLParams = (url) => new URLSearchParams(url)
              startup()

              function startup(){                
                //loadBaseMaps()
                basemapFeatureLayerActiveCheck(tileLayerTxDOT, "basemapLayer")
                window.onload = async () => {
                  await loadTOCContent()
                  initBasemapOverlayToggle()
                  onViewLoad()
                  readUrlParams()
                }
              }
              
              //Drag and Drop---------------------------------------------------
              var dropZone = document.getElementById('viewDiv');
              
              dropZone.addEventListener('drop', function(event) {
                event.preventDefault();
                var file = event.dataTransfer.files[0];
              
                if (file.type === 'text/csv') {
                  var reader = new FileReader();
                  reader.addEventListener('load', function(event) {
                    var csv = event.target.result;
                    var rows = csv.split('\n');
      
                    rows = rows.filter(function(row) {
                      return row.trim() !== '';
                    });
              
                    var data = rows.map(function(row) {
                      var values = row.match(/(?:[^,"]+|"[^"]*")+/g);
                      return values.map(function(value) {
                        return value.replace(/^"(.*)"$/, '$1');
                      });
                    });
                    handleDropFile(data);
                  });
              
                  reader.readAsText(file);
                } else {
                  alert('Please drop a CSV file');
                }
              });
              
              dropZone.addEventListener('dragover', function(event) {
                event.preventDefault();
              });
              
              function handleDropFile(data) {
                for (var i = 1; i < data.length; i++) {
                  getLineworkWithM(data[i][0],data[i][1],data[i][2],data[i][3],data[i][4],data[i][5]);
                }
              }
              
              const getGraphic = (id) => graphicsLayer.graphics.items.find(x => Object.values(x.attributes).toString() === id)

              function removeEventGraphic(id){
                let index = Number(id)
                let getGraphics = getGraphic(id)
                graphicsLayer.remove(getGraphics)
              }

              function addGraphicToEventDisplay(){
                let gItem = graphicsLayer.graphics.items.at(-1)
                let id = Object.values(gItem.attributes).toString()
                let graphSpan = document.createElement("span")
                let containerDiv = document.createElement("div")
                let graphDiv = document.createElement("div")
                graphSpan.className = "graphSpan"
                graphDiv.width = "70%"
                containerDiv.id = id
                graphDiv.id = "graphDiv"
                graphDiv.className = "esri-icon-close-circled"
                containerDiv.className = "containerDiv"
                graphDiv.onclick = () => {
                  let element = document.getElementById(id)
                  removeEventGraphic(element.id)
                  element.remove()
                  if(!graphicsLayer.graphics.length){
                    document.getElementById("btnGenerateURL").disabled = true
                    document.getElementById("btnExportToKML").disabled = true
                  }

                }

                graphSpan.textContent = `Route: ${gItem.attributes[0]} DFO: ${gItem.attributes[1]} - ${gItem.attributes[2]}`
                containerDiv.appendChild(graphSpan)
                containerDiv.appendChild(graphDiv)
                document.getElementById("graphics").appendChild(containerDiv)
              }

              //data is an array of Route ID, From DFO, To DFO ["IH0035-KG",15,30], rework to loop through records in the file
              async function getLineworkWithM(rteID,frmDFO,toDFO,theColor,theWidth,theDescription) {
                document.getElementById("btnEventMap").textContent = "Loading...."
                document.getElementById("btnEventMap").disabled = true
                var url = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Roadways/FeatureServer/0";
                var paraMeters = "/query?f=json&where=RTE_NM='" + rteID + "'&returnGeometry=true&returnM=true";
                let resp = await request(url+paraMeters)
                document.getElementById("btnEventMap").textContent = "Add to Map"
                document.getElementById("btnEventMap").disabled = false

                try{
                  let isWalkGeom = walkGeom(resp,rteID,frmDFO,toDFO,theColor,theWidth,theDescription);
                  if(!isWalkGeom){
                    document.getElementById("btnExportToKML").disabled = false
                    document.getElementById("btnGenerateURL").disabled = false
                  }
                  return isWalkGeom   
                }
                catch(err){
                  console.log(err)
                  queryResponseUI({para: "Incorrect Values. Try again.", header:"Error"},  null, height="250px", width="350px")
                  document.getElementById("btnUpdateLRM").textContent = "Create Diagram"
                  document.getElementById("btnUpdateLRM").disabled = false
                  document.getElementById("parentCanvas").style.display = "none";
                  return true
                }
              }
              
              function walkGeom(theGeom,rteID,theBegin,theEnd,theColor,theWidth,theDescription) {
                if(!theGeom.data.features.length){
                  queryResponseUI({para: "Incorrect Route ID. Try again.", header:"Error"}, null, height="250px", width="350px")
                  document.getElementById("btnUpdateLRM").textContent = "Create Diagram"
                  document.getElementById("btnUpdateLRM").disabled = false
                  return true 
                }
                var theGeomPart;
                var coordX;
                var coordY;
                var coordM;
                var newLinePoints = [];
                for (var a=0; a < theGeom.data.features.length; a++) {
                  theGeomPart = theGeom.data.features[a].geometry.paths; 
                  for (var j = 0; j < theGeomPart[0].length; j++) {
                      coordX = theGeomPart[0][j][0];
                      coordY = theGeomPart[0][j][1];
                      coordM = theGeomPart[0][j][2];
                      if((coordM>=theBegin&&coordM<=theEnd)){
                        newLinePoints.push([a,0,j,coordX,coordY]);                        
                      }
                      else if(!newLinePoints.length && coordM>=theBegin){
                        newLinePoints.push([a,0,j,theGeomPart[0][j][0],theGeomPart[0][j][1]]);
                      }
                  }
                }
                //Loop through the results and split up the array based on any segment breaks
                let result = [];
                let currentArr = [newLinePoints[0]];
                for (let i = 1; i < newLinePoints.length; i++) {
                  if (newLinePoints[i][0] !== currentArr[0][0]) {
                    result.push(currentArr);
                    currentArr = [newLinePoints[i]];
                  } else {
                    currentArr.push(newLinePoints[i]);
                  }
                }
                result.push(currentArr); 

                var indexOne;
                var indexTwo;
                var indexThree;
                var segmentArrayLength;
                
                //Loop through the results extend the events and add to the map
                for (var z = 0; z < result.length; z++) {
                  //For the first point on the segment
                  indexOne = result[z][0][0]
                  indexTwo = result[z][0][1];
                  indexThree = result[z][0][2];   

                  if (indexThree>0) {
                    var pointOneX = theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree-1][0];
                    var pointOneY = theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree-1][1];
                    var pointTwoX = theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree][0];
                    var pointTwoY = theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree][1]; 
                    var definedLength = theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree][2]-theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree-1][2]; //the m difference between vertices
                    var lengthFromFirstPoint = theBegin-theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree-1][2];  //event from-beginning vertex m
                    var newBeginPoint = interpolatePoint(pointOneX,pointOneY,pointTwoX,pointTwoY,definedLength,lengthFromFirstPoint);
                    
                    //Add to the beginning of the array
                    //Don't run unless distance is greater than .001
                    if (lengthFromFirstPoint>.001) {
                        result[z].unshift([0,0,0,newBeginPoint[0],newBeginPoint[1]]);                  
                    }
                  }      
                  
                  segmentArrayLength = result[z].length;
                  
                  //For the last point on the segment
                  indexOne = result[z][segmentArrayLength-1][0];
                  indexTwo = result[z][segmentArrayLength-1][1];
                  indexThree = result[z][segmentArrayLength-1][2];
                  
                  if (indexThree<theGeom.data.features[indexOne].geometry.paths[indexTwo].length-1) {
                    var pointOneX = theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree][0];
                    var pointOneY = theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree][1];
                    var pointTwoX = theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree+1][0];
                    var pointTwoY = theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree+1][1]; 
                    var definedLength = theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree+1][2]-theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree][2]; //the m difference between vertices
                    var lengthBeyondLastPoint = theEnd-theGeom.data.features[indexOne].geometry.paths[indexTwo][indexThree][2];  //event from-ending vertex m
                    var newEndPoint = interpolatePoint(pointOneX,pointOneY,pointTwoX,pointTwoY,definedLength,lengthBeyondLastPoint);
                    //Adding to the end of the array
                    //Don't run unless distance is greater than .001
                    if(lengthBeyondLastPoint < 0){
                      result[z].pop()
                      result[z].push([0,0,0,newEndPoint[0],newEndPoint[1]])
                    }
                    if (lengthBeyondLastPoint>.001) {
                      result[z].push([0,0,0,newEndPoint[0],newEndPoint[1]]);
                    }     
                  }
                }
                let finalResult = result.map(subArr => subArr.map(innerSubArr => innerSubArr.slice(3)));
                for (var x = 0; x < finalResult.length; x++) {
                  var line = new Polyline({
                    paths: [finalResult[x]],
                    spatialReference: { wkid: 102100 }
                  });
          
                  lineGraphic = new Graphic({
                    attributes: [rteID,theBegin,theEnd,theColor,theWidth,theDescription],
                    geometry: line,
                    symbol: {
                      type: "simple-line",
                      color: theColor,
                      width: theWidth
                    },
                    popupTemplate: new PopupTemplate({
                      title: rteID,
                      content: theDescription

                    })                  
                  });
                  //Add line to map
                  graphicsLayer.add(lineGraphic);
                  
                  addGraphicToEventDisplay(lineGraphic)              
                }
                
                zoomToGraphicExtent();
              }
              
              //Finding the begin/end point of the event
              function interpolatePoint(pointOneX,pointOneY,pointTwoX,pointTwoY,totalLength,segmentLength){
                const ratio = (segmentLength*1609.344) / (totalLength*1609.344);
                // Interpolate the Web Mercator coordinates of the point along the line
                const interpolatedMercator = [
                  pointOneX + (ratio * (pointTwoX - pointOneX)),
                  pointOneY + (ratio * (pointTwoY - pointOneY))
                ];                

                var newCoord = [interpolatedMercator[0],interpolatedMercator[1]];
                return newCoord;
              }
              //End drag and drop-----------------------------------------------
              
              //Base map tile layers--------------------------------------------
              function loadBaseMaps(txdotLayerUrl){
                //let returnUrl = basemapFeatureLayerActiveCheck(tileLayerTxDOT)
                //console.log(returnUrl)
                txdotLayer = new VectorTileLayer({
                  url: txdotLayerUrl,
                  visible: false,
                  name: "txdot"
                }); 
                //Light Gray Layer
                lightGrayLayer = new VectorTileLayer({
                    url: tileLayerLightGray,
                    visible: false,
                    name: "lightgray"
                });

                //Dark Gray Layer
                darkGrayLayer = new VectorTileLayer({
                    url: tileLayerDarkGray,
                    visible: false,
                    name: "darkgray"                  
                });    

                //ESRI Streets Layer
                streetsLayer = new VectorTileLayer({
                    url: tileLayerStreets,
                    visible: false,
                    name: "esristreets"                  
                });

                let OSMBasemap = new OpenStreetMapLayer({
                  visible: false,
                  name: "osm"
                })

                let texasImagery = new WMTSLayer({
                  url: "https://txgi.tnris.org/login/path/corner-express-popcorn-compact/wmts",
                  serviceMode: "KVP",
                  activeLayer: {
                    id: "texas",
                    tileMatrixSets: ["0to20"],
                    imageFormat: "png"
                  },
                  visible: false,
                  name: "imagery"
                })

                
                map.addMany([txdotLayer,lightGrayLayer, darkGrayLayer, streetsLayer, OSMBasemap, texasImagery]);

                basemapAll = [{name: "txdot", featLayer: txdotLayer}, {name: "lightgray", featLayer: lightGrayLayer}, 
                                  {name: "darkgray", featLayer: darkGrayLayer}, {name: "esristreets", featLayer: streetsLayer},
                                  {name: "osm", featLayer: OSMBasemap}, {name: "imagery", featLayer: texasImagery}]
                return;                    
              }
              
              view = new MapView({
                container: "viewDiv",
                map: map,
                center: [-100, 31.5],
                zoom: 6
              });       
              
              view.ui.remove("attribution");
              
              view.constraints = {
                minZoom: 5,
                maxZoom: 21,
                rotationEnabled: false,
                geometry:{
                  type: "extent",
                  xmin: -107.0387,
                  ymin: 25.8167,
                  xmax: -93.3976,
                  ymax: 36.825,
                }
              };
            
              //Scale Bar-------------------------------------------------------
              var scaleBar = new ScaleBar({
                view: view,
                unit: "miles",
                name: "scalebar"
              });
              
              let searchBar = new Search({
                view: view,
                visible: false,
                allPlaceholder: "Search for TxDOT Item",
                includeDefaultSources: false,
                container: searchBox,
                name: "searchbar",
                sources:[{
                  //categories: ["Coordinate System"],
                  name: "Latitude/Longitude",
                  url: "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer",
                  singleLineFieldName: "SingleLine",
                  suggestionsEnabled: false,
                  placeholder: "34.24190694,-101.12269563",
                  localSearchDisabled: true,
                }]
              });

              view.ui.add(searchBar, {
                position: "top-left",
              })

              let legend = new Legend({
                view: view,
                visible: false,
                hideLayersNotInCurrentView: true,
              })

              view.ui.add(legend,{
                position: "bottom-right"
              })

              view.ui.add(scaleBar, {
                position: "bottom-left"
              });
              
              scaleBar.style = "";

              let printer;
              document.getElementById("print").addEventListener("click", ()=>{
                if(!printer){
                  activateToolButton("print")
                  printer = new Print({
                    view: view,
                    printServiceUrl: "https://maps.txdot.gov/createags/rest/services/CustomPrint/GPServer/Export%20Web%20Map",
                    visible: true,
                    name: "print",
                  }) 
                  
                  view.ui.add(printer, {
                    position: "bottom-right"
                  })
                  resetToolButtons("print")
                  return
                }

                if(printer.visible === false){
                  printer.visible = true
                  activateToolButton("print")
                  resetToolButtons("print")
                  return
                }

                turnOffPrint()
                return
              })

              function turnOffPrint(){
                printer ? printer.visible = false : null
                resetButton("print")
              }

              //End Scale Bar---------------------------------------------------
              
              //Measure---------------------------------------------------------
              let measurementWidget = new DistanceMeasurement2D({
                  view: view,
                  name: "measure",
                  visible: false,
                  activeTool: "distance",
                  unit: "miles",
              });
              view.ui.add(measurementWidget, "bottom-right");  
              
              const measureListener = document.querySelector('#measureButton');
              measureListener.addEventListener('click', (event) => {
                
                if (measurementWidget.visible == true) {
                  turnOffMeasurement()
                  measurementWidget.viewModel.clear()
                } else {
                    measurementWidget.visible = true;
                    measurementWidget.viewModel.start()
                    resetButton("lrsButton");
                    lrsButtonStatus=false;
                    clearInnerHTML("mapClickResults");                     
                    activateToolButton("measureButton");
                    graphicsLayer.removeAll();
                    resetToolButtons("measureButton")                  
                }
              });
              
              function turnOffMeasurement(){
                measurementWidget.visible = false;
                resetButton("measureButton");  
              }
              //End Measure-----------------------------------------------------
              
              //Search-----------------------------------------------------------------------
              searchBar.when((search) => {
                document.getElementById("searchTool").addEventListener("click", (event) =>{
                  if(searchBar.visible === true){
                    searchBar.visible = false
                    resetButton("searchTool")
                    return
                  }

                  searchBar.visible = true
                  activateToolButton("searchTool")
                  return
                })
              })
              //End Search--------------------------------------------------------------------

              //Load Roadway Inventory forms------------------------------------
              function resetTabInput(tabname){
                let inputs = document.getElementById(tabname).getElementsByTagName("input")
                let selects = document.getElementById(tabname).getElementsByTagName("select")

                for(i in inputs){
                  if(inputs[i].id === "eventWidth" || inputs[i].id === "RoadInventory" || inputs[i].id === "Bridges"){
                    continue
                  }
                  inputs[i].value = ""
                }
                for(i in selects){
                  if(selects[i].id === "eventColors" || selects[i].id === "field"){
                    continue
                  }
                  selects[i].value = ""
                }
              }

              function queryCheckOnLoad(){
                let field = document.getElementById("field")
                let operator = document.getElementById("operator")
                let value = document.getElementById("value")
                operator.value = ""
                value.value.length > 0 ? value.disabled = false : value.disabled = true
              }

              function eventCheckOnLoad(){
                let eventBeginDFO = document.getElementById("eventBeginDFO")
                let eventEndDFO = document.getElementById("eventEndDFO")
                let eventColors = document.getElementById("eventColors")
                let eventWidth = document.getElementById("eventWidth")
                let eventDesc = document.getElementById("eventDescription")
              
                eventBeginDFO.value.length > 0 ? eventBeginDFO.disabled = false : eventBeginDFO.disabled = true
                eventEndDFO.value.length > 0 ? eventEndDFO.disabled = false : eventEndDFO.disabled = true
                eventColors.value.length > 0 ? eventColors.disabled = false : eventColors.disabled = true
                eventWidth.value.length > 0 ? eventWidth.disabled = false : eventWidth.disabled = true
                eventDesc.value.length > 0 ? eventDesc.disabled = false : eventDesc.disabled = true
              }

              function SRDCheckOnLoad(){
                let inpSRDFromDFO = document.getElementById("inpSRDFromDFO")
                let inpSRDToDFO = document.getElementById("inpSRDToDFO")
                let riAttributes = document.getElementById("riAttributes")

                inpSRDFromDFO.value.length > 0 ? inpSRDFromDFO.disabled = false : inpSRDFromDFO.disabled = true
                inpSRDToDFO.value.length > 0 ? inpSRDToDFO.disabled = false : inpSRDToDFO.disabled = true
              }

              const getCurrentQuerySelection = () => document.querySelector(`input[name="featQuery"]:checked`).value

              function disableQuery(){
                let isChecked = document.querySelector(`input[name="featQuery"]:checked`)
                if(!isChecked){
                  for(let i in document.querySelector('#queryTab').childNodes[1]){
                    if(i > 1){
                      document.querySelector('#queryTab').childNodes[1][i].disabled = true
                    }
                    else{
                      
                    }
                  }
                  return true
                }
                return false
              }

              function checkFieldStatus(tabname, isAllDisabled){
                let getItems = document.querySelector(tabname)
                let inputFields = getItems.querySelectorAll(".noDisabled1")
                inputFields.forEach((x,i) =>{
                  if(x.tagName === "SELECT"){
                    selectEventListner(x.id)
                  }
                  else{
                    inputEventListner(x.id)
                  }
                })
              }
              document.getElementById("RoadInventory").addEventListener("change", () => {
                document.getElementById("field").disabled = false
                document.getElementById("operator").disabled = false
              })

              document.getElementById("Bridges").addEventListener("change", () => {
                document.getElementById("field").disabled = false
                document.getElementById("operator").disabled = false
              })


              function selectEventListner(id){
                document.getElementById(id).addEventListener("change", (event)=>{
                  if(event.target.value != ""){
                    event.target.nextElementSibling.disabled = false
                    if(event.target.type.includes("select")){
                      let classBtn = event.target.nextElementSibling.className.split(" ")
                      document.querySelectorAll(`.${classBtn[1]}`).forEach(x => {
                        x.disabled = false
                      })
                    }
                    
                  }
                  else{
                    event.target.nextElementSibling.disabled = true
                    if(event.target.type === "select-multiple"){
                      let classBtn = event.target.nextElementSibling.className.split(" ")
                      let noEnable = ["btnQueryGenerateURL", "btnExportToCSV"]
                      document.querySelectorAll(`.${classBtn[1]}`).forEach(x => x.disabled = true)
                    }
                  }
                })
              }

              function inputEventListner(id){
                document.getElementById(id).addEventListener("input", (event)=>{
                  displayErrorMsg(event.target.validity, event.target.form.name)
                  if(event.target.value != ""){
                    if(event.target.nextElementSibling.tagName === 'SPAN'){
                      event.target.nextElementSibling.nextElementSibling.disabled = false
                    }
                    if(event.target.id === 'eventEndDFO'){
                      document.getElementById("eventColors").disabled = false
                      document.getElementById("eventColors").value = "#000000"
                      document.getElementById("eventWidth").disabled = false
                      document.getElementById("eventWidth").value = "4"
                      document.getElementById("eventDescription").disabled = false
                      document.getElementById("btnRemoveAll").disabled = false
                      document.getElementById("btnEventMap").disabled = false
                    }
                    event.target.nextElementSibling.disabled = false
                    
                  }
                  else{
                    event.target.nextElementSibling.disabled = true
                  }
                })
              }

              function toggleQueryBtns(id, status) {
                let btns = document.getElementById(id).getElementsByTagName("button")
                for(let btn in btns){
                  btns[btn].disabled = status
                }
              }

              function displayErrorMsg(validity, formName){
          
                let errorMsg = {"badInput": "Numeric values only", "rangeOverflow": "A number between 1-8 is required", "rangeUnderflow": "A number between 1-8 is required", 
                                "typeMismatch": "An invalid type. Try again.", "valueMissing":"Value is Missing.", "stepMismatch":"Field requires 3 decimal places."}
                
                for(let k in validity){
                  if(validity[k] === true){
                    document.getElementById(formName).textContent = errorMsg[k]
                    return
                  }
                  document.getElementById(formName).textContent = ""
                  continue
                }
              }

              function pageBtnDisable(id){
                if(conditions.length === 0){
                  toggleQueryBtns(id, true)
                }
                
              }
              

              function onViewLoad(){
                let url = getURLParams(window.location.search)
                let getQueryType = url.get("queryType") ? url.get("queryType") : document.querySelector(`input[name="featQuery"]:checked`) ? document.querySelector(`input[name="featQuery"]:checked`).value : "RoadInventory"

                let getCurrentFeatLayer = retrieveFeatureLayer(getQueryType)
                view.whenLayerView(getCurrentFeatLayer[0]).then(function(layerView) {
                  populateQueryForm(getQueryType);

                });
                  view.popup = new Popup({
                    dockOptions: {
                      position: "top-right",
                    },
                    container: expandPopup
                  })
                if(conditions.length < 1){
                  document.getElementById("outputFields").disabled = true
                  clearConditions()
                }
                return;
              }
              
              //Re-orders array
              function sendItemToFront(theArray,itemsToMove) {
                let copyRdsInventoryArr = [...new Set([...itemsToMove,...theArray])]              
                return copyRdsInventoryArr;
              }

              function setRoadwayQuery(){
                //clear current contents in outputFields first
                var roadwayInventoryFieldsArray = featureLayerView;
                let arrToMove = ["RIA_RTE_ID", "FRM_DFO", "TO_DFO", "C_SEC", "BMP", "EMP"]
                let returnRdwyInventoryArr = sendItemToFront(roadwayInventoryFieldsArray,arrToMove)
                return returnRdwyInventoryArr
              }

              function setBridgeQuery(){
                //clear current contents in outputFields first
                return bridgeInventoryFieldsArray
              }

              function selectQuery(event){
                if(document.getElementById("outputFields").textContent.length ){
                  document.getElementById("outputFields").textContent = ""
                  document.getElementById("field").textContent = ""
                  let resetItem = event === "RoadInventory" ? "Bridges" : "RoadInventory"
                  resetFeatureLayer(resetItem)
                  populateQueryForm(event)
                  return
                }
                populateQueryForm(event)
              }

              async function populateQueryForm(type) {
                //On startup, roadway inventory should display
                //On selection of either option, fields should auto load
                let populateQueryFormPromise = new Promise((res,rej) =>{
                  var fieldSelect = document.getElementById('field');
                  var outputFieldsSelect = document.getElementById('outputFields');

                  let returnRdwyInventoryArr = type === "RoadInventory" ? setRoadwayQuery() : setBridgeQuery() 
                  

                  for (var i = 0; i < returnRdwyInventoryArr.length; i++) {
                    var field = returnRdwyInventoryArr[i];
                    var optionField = document.createElement("option");
                    var optionSelect = document.createElement("option");
                    
                    optionSelect = document.createElement("option");
                    optionField.text = field.toUpperCase();
                    optionField.value = field;
                    optionSelect.text = field.toUpperCase();
                    optionSelect.value = field;                  
                    outputFieldsSelect.appendChild(optionSelect);
                    fieldSelect.appendChild(optionField);                  
                  }
                  res("complete")
                })

                return await populateQueryFormPromise
                
              }
              //End populate Inventory forms------------------------------------
    
              //LRS Identify----------------------------------------------------
              const lrsListener = document.querySelector('#lrsButton');
              lrsListener.addEventListener('click', (event) => {
                lrsButtonStatus === true ?  turnOffLRS() : turnOnLRS()
              });

              function turnOffLRS(){
                if(document.getElementById("sketchTab").style.display === "block"){
                  sketchDraw()
                }queryToUrl
                resetButton("lrsButton");
                lrsButtonStatus = false;
                clearInnerHTML("mapClickResults");
                graphicsLayerLRSIdentify.removeAll();
                document.getElementById("viewDiv").style.cursor = "pointer"
              }

              function turnOnLRS(){
                if(document.getElementById("sketchTab").style.display === "block"){
                  removeDrawEvent()
                }
                resetButton("measureButton");
                measurementWidget.visible = false;                    
                activateToolButton("lrsButton");
                lrsButtonStatus = true;
                clearInnerHTML("mapClickResults");
                resetToolButtons("lrsButton")
                document.getElementById("viewDiv").style.cursor = "crosshair"
                setElementText("mapClickResults", "Click a spot on a roadway.")
                return
              }

              function rightClickUrlDisplay(evt){
                //get overlays that are visible
                let isVisibleLayers = returnVisibleLayers()
                 if (evt.button === 2) {
                    let point = view.toMap({x: evt.x, y: evt.y});
        
                    const basemaps = view.layerViews.items.filter(f => f.layer.type !== "feature")
                    const mapForURL = basemaps.find(f => f.layer.visible === true).layer.name 

                    let overlayUrl = isVisibleLayers.length ? `overlays=${isVisibleLayers.toString()}&map=${mapForURL}&location=${point.latitude.toFixed(8)},${point.longitude.toFixed(8)},${view.zoom}` : `map=${mapForURL}&location=${point.latitude.toFixed(8)},${point.longitude.toFixed(8)},${view.zoom}`
                    let rightClickURL = `${window.location.origin}${window.location.pathname}?${overlayUrl}`
                    var latLongOnly = point.latitude.toFixed(8)+","+point.longitude.toFixed(8);
                    
                    queryToUrl(rightClickURL, {type:"Coords", coord: latLongOnly, name: "COPY XY"})
                  }
              }

              view.on("click",function(event){
                 if (lrsButtonStatus==true) {
                    graphicsLayerLRSIdentify.removeAll();
                    let point = view.toMap({x: event.x, y: event.y});
                    var url = "https://lrs-ext.us-e1.cloudhub.io/api/elrs1?Lat="+point.latitude.toFixed(8)+"&Lon="+point.longitude.toFixed(8);
                    
                    //add graphic to map
                    var pointGraphic = new Graphic({
                          geometry: point,
                          symbol: {
                            type: "simple-marker",
                            color: "red",
                            size: "10px"
                          }
                    });      
                    
                    graphicsLayerLRSIdentify.add(pointGraphic);
                    setElementText("mapClickResults", "Calculating LRMs...")
                    //Populate LRS Readout
                    request(url).then(function(response) {
                        processLRSResponse(response);
                    }
                    
                    );
                    event.stopPropagation()                  
                 } 
                 rightClickUrlDisplay(event)

                                
              });
              
              function returnVisibleLayers(){
                let visibleLayer = []
                let getVisibleLayers = itemArr.filter(x => x.visible === 1)
                getVisibleLayers.forEach(y => visibleLayer.push(y.name))
                return visibleLayer
              }
              
              const setElementText = (elementName, setValue) => document.getElementById(elementName).innerHTML = setValue

              function processLRSResponse(theResponse) {
                var numbers = theResponse.data;
                var lowestNumber = numbers[0].distance;
                var lowestIndex = 0;
                
                for (var i = 1; i < numbers.length; i++) {
                  if (numbers[i] < lowestNumber) {
                    lowestNumber = numbers[i];
                    lowestIndex = i;
                  }
                }     
                
                var lrsReadoutData=[];
                lrsReadoutData.push(["Control Section",theResponse.data[lowestIndex].CTRL_SECT_LN_NBR]);
                lrsReadoutData.push(["Mile Point",theResponse.data[lowestIndex].CTRL_SECT_MPT]); 
                lrsReadoutData.push(["Reference Marker",theResponse.data[lowestIndex].RMRKR_PNT_NBR]);
                lrsReadoutData.push(["Displacement",theResponse.data[lowestIndex].RMRKR_DISPLACEMENT]);                 
                lrsReadoutData.push(["Route",theResponse.data[lowestIndex].RTE_DEFN_LN_NM]);
                lrsReadoutData.push(["Distance From Origin",theResponse.data[lowestIndex].RTE_DFO]);
                lrsReadoutData.push(["Latitude",theResponse.data[lowestIndex].LAT.toFixed(6)]);
                lrsReadoutData.push(["Longitude",theResponse.data[lowestIndex].LON.toFixed(6)]);
                
                if (document.getElementById("diagramTab").style.display == "block"||document.getElementById("eventTab").style.display == "block") {
                  document.getElementById("inpSRDRouteID").value = theResponse.data[lowestIndex].RTE_DEFN_LN_NM;
		              document.getElementById("eventRoute").value = theResponse.data[lowestIndex].RTE_DEFN_LN_NM;
                  theResponse.data[lowestIndex].RTE_DFO ?? setElementText("mapClickResults", "Road was not detected. Move Closer.")
                  var startingDFO = Number(theResponse.data[lowestIndex].RTE_DFO.toFixed(3));
                 if ((startingDFO-1)<0) {
                    document.getElementById("inpSRDFromDFO").value = Number(startingDFO.toFixed(3));
                    document.getElementById("inpSRDToDFO").value = Number((startingDFO+1).toFixed(3));
                    document.getElementById("eventBeginDFO").value = Number(startingDFO.toFixed(3));
                    document.getElementById("eventEndDFO").value = Number((startingDFO+1).toFixed(3));
                  } else {
                    document.getElementById("inpSRDFromDFO").value = Number((startingDFO-1).toFixed(3));
                    document.getElementById("inpSRDToDFO").value = Number((startingDFO+1).toFixed(3)); 
                    document.getElementById("eventBeginDFO").value = Number((startingDFO-1).toFixed(3));
                    document.getElementById("eventEndDFO").value = Number((startingDFO+1).toFixed(3));                 
                  }
                  
                  ["#diagramTab","#eventTab"].forEach((x) =>{
                      let getField = document.querySelectorAll(x)
                      for(let a=0; a < getField[0].children[0].length; a++){
                        if(getField[0].children[0][a].tagName != "BUTTON" && getField[0].children[0][a].value.length){
                            getField[0].children[0][a].disabled = false
                            if(getField[0].children[0][a].nextElementSibling.tagName === "SPAN"){
                              getField[0].children[0][a].nextElementSibling.nextElementSibling.disabled = false
                              if(getField[0].children[0][a].nextElementSibling.nextElementSibling.id === "eventColors"){
                                 getField[0].children[0][a].nextElementSibling.nextElementSibling.value = "#000000"
                                 getField[0].children[0][a].nextElementSibling.nextElementSibling.nextElementSibling.value = "4"
                                 document.getElementById("btnEventMap").disabled = false;
                              }
                            }
                            getField[0].children[0][a].nextElementSibling.disabled = false
                            
                        }
                      }
                  })
                 
                }
               
                var table = document.createElement("table");
                table.setAttribute("id", "lrsOutputTable");
                
                for (i = 0; i < lrsReadoutData.length; i++) {
                  var row = document.createElement("tr");
                  for (var j = 0; j < lrsReadoutData[i].length; j++) {
                    var cell = document.createElement("td");
                    var cellText = document.createTextNode(lrsReadoutData[i][j]);
                    cell.appendChild(cellText);
                    row.appendChild(cell);
                  }
                  table.appendChild(row);
                }
                
                clearInnerHTML("mapClickResults");
                document.getElementById("mapClickResults").appendChild(table);
                
                //Create element for exporting LRS results
                var newSpan = document.createElement("span");
                newSpan.setAttribute("id", "exportSpan");                
                newSpan.innerHTML = "Export Readout";
              
                newSpan.addEventListener("click", function() {
                  exportTableToCSV("#lrsOutputTable");
                });
                
                document.getElementById("mapClickResults").appendChild(newSpan); 
              }
              //End LRS Identify------------------------------------------------

              //Lat Long Coordinates on mouse move------------------------------
              view.when((v) => {
                reactiveUtils.when(
                  () => v.stationary,
                  () => {
                    document.getElementById("zoom").textContent = `Level: ${v.zoom},`
                    v.watch("zoom", (z)=>{
                      if(Number.isInteger(v.zoom)){
                        document.getElementById("zoom").textContent = `Level: ${v.zoom},`
                        getActiveLayers(v.zoom)
                      }
                    })
                    //getActiveLayers(v.zoom)
                  }
                )
                  
                v.on('pointer-move',function(event){
                  let point = v.toMap({x: event.x, y: event.y});
                  setElementText("coords", point.latitude.toFixed(6) + ", " + point.longitude.toFixed(6))
                });
              })

              //End Lat Long Coordinates----------------------------------------

              //Listeners-------------------------------------------------------
              //Jump to Google listener
              const jumpGoogleListener = document.querySelector('#googleMaps');
              jumpGoogleListener.addEventListener('click', (event) => {
                openGoogleMaps();
              }); 

              document.getElementById("legend").addEventListener("click", (event) => {
                if(legend.visible === true){
                  legend.visible = false
                  resetButton("legend")
                  return
                }

                activateToolButton("legend")
                legend.visible = true
                return
              })

              function turnOffLegend(){
                legend.visible = false
                resetButton("legend")
              }

              function toggleLayer(id){
                if(basemapAll.find(x => x.name === id)) return toggleBaseMap(id)
                let returnId = itemArr.find(it => it.name === id)
                if(!returnId) return removeOverlay(id)

                let layerId = retrieveFeatureLayer(returnId.name)
                layerId.forEach(x => x.visible === true ? setInvisible(x, returnId, id) : setIsVisible(x, returnId, id))

                let isVisible = itemArr.find(x => x.visible)
                isVisible ? resetBaseMapItem("CLEAR") : activateBaseMapItem("CLEAR")
                map.reorder(layerId[0], itemArr.length+1)
                getActiveLayers(view.zoom)
                return
              }

              function retrieveFeatureLayer(name){
                let layerId = map.layers.items.filter((lyrId) => {
                  if(lyrId.name === name){
                    return lyrId
                  }
                })
                return layerId
              }

              function setInvisible(layerId, returnId, id){
                layerId.visible = false;
                resetBaseMapItem(id)
                returnId.visible = 0
                resetButton("legend")
                if(layerId.name === "Bridges" || layerId.name === "RoadInventory"){
                  layerId.definitionExpression = ""
                }

              }

              function setIsVisible(layerId, returnId, id){
                layerId.visible = true;
                activateBaseMapItem(id)
                returnId.visible = 1
                return
              }

              function initBasemapOverlayToggle(){
                document.getElementById("tocMaps").addEventListener("click", (event)=>{
                  if(event.target.id === "CLEAR") return clearOverlay()
                  if(event.target.id === "layerSearch") return
                  return toggleLayer(event.target.id)
                })
              }

              function toggleBaseMap(idName){
                resetAllBaseMapItems();
                activateBaseMapItem(idName);
                let basemap = basemapAll.find(x => x.name === idName)
                basemap.featLayer.visible = true
                return
              }

              function clearOverlay(){
                let overlayVisible = itemArr.filter(x => x.visible === 1)
                overlayVisible.forEach((x) => {
                  toggleLayer(x.name)
                  document.getElementById(`dwnloadBtn${x.name}`).style.display = "none"
                })
                
              }

              //Clear and Reset Map Listener
              const resetListener = document.querySelector('#resetMap');
              resetListener.addEventListener('click', (event) => {
                clearAndResetMap();
                clearOverlay()

              }); 
              
              //Maps tab listener
              const baseMapListener = document.querySelector('#baseMaps');
              baseMapListener.addEventListener('click', (event) => {
                resetAllTabs();
                activateButton("baseMaps");
                document.getElementById("mapTab").style.display = "block";
                document.getElementById("viewDiv").style.cursor = "default"
              }); 
              
              //Query tab listener
              const queryListener = document.querySelector('#dataQuery');
              queryListener.addEventListener('click', (event) => {
                resetAllTabs();
                resetTabInput("queryTab")
                let isAllDisabled = disableQuery()
                activateButton("dataQuery");
                pageBtnDisable("queryTab")
                checkFieldStatus("#queryTab", isAllDisabled)
                document.getElementById("queryTab").style.display = "block";
                document.getElementById("viewDiv").style.cursor = "default"
                document.querySelectorAll(".qryBtn").forEach(x => x.disabled = true)
                document.getElementById("outputFields").disabled = true
                document.getElementById("conditions").querySelectorAll(".queryCondition").forEach(x => x.remove())           
              });   
              
              //Roadway diagram listener
              const roadwayDiagramListener = document.querySelector('#roadwayDiagram');
              roadwayDiagramListener.addEventListener('click', (event) => {
                resetAllTabs();
                resetTabInput("diagramTab")
                inputEventListner("inpSRDRouteID")
                let isAllDisabled = disableQuery()
                activateButton("roadwayDiagram");
                pageBtnDisable("diagramTab");
                checkFieldStatus("#diagramTab", isAllDisabled)
                document.getElementById("diagramTab").style.display = "block";
                document.getElementById("viewDiv").style.cursor = "default"   
                document.getElementById("riAttributes").disabled = true 
                document.querySelectorAll(".srdBtn").forEach(x => x.disabled = true)  
              });    
              
              //Event tab listener
              const eventTabListener = document.querySelector('#eventForm');
              eventTabListener.addEventListener('click', (event) => {
                resetAllTabs();
                resetTabInput("eventTab")
                inputEventListner("eventRoute")
                let isAllDisabled = disableQuery()
                activateButton("eventForm");
                pageBtnDisable("eventTab")
                checkFieldStatus("#eventTab", isAllDisabled)
                document.getElementById("eventTab").style.display = "block";       
                document.getElementById("viewDiv").style.cursor = "default"
                document.getElementById("eventBeginDFO").disabled = true
                document.getElementById("eventEndDFO").disabled = true
                document.getElementById("eventColors").disabled = true
                document.getElementById("eventWidth").disabled = true
                document.getElementById("eventDescription").disabled = true
                document.querySelectorAll(".eventBtn").forEach(x => x.disabled = true)
              });               
              
              //Graphic sketch listener
              const graphicSketchListener = document.querySelector('#graphicSketch');
              graphicSketchListener.addEventListener('click', (event) => {
                resetAllTabs();
                activateButton("graphicSketch");
                document.getElementById("sketchTab").style.display = "block";
                
                document.getElementById("btnRecalcProject").disabled = true
                sketchDraw()   
              }); 
              
              //Check LRM Inputs listener
              const lrmInputsListener = document.querySelector('#btnUpdateLRM');
              lrmInputsListener.addEventListener('click', (event) => {
                event.target.textContent = "Loading..."
                event.target.disabled = true;
                document.getElementById("btnToggleDiagramView").disabled = false
                document.getElementById("btnToggleDiagramView").textContent = "Hide Diagram"
                document.querySelectorAll(".srdBtn").forEach(x => x.disabled = true)
                document.getElementById("riAttributes").disabled = true
                document.getElementById("parentCanvas").style.display = "none"
                graphicsLayer.removeAll();
                checkLRMInputs();
                resetSrdSelectOption()
              })
              
              //Add Inventory Attribute listener
              const addInventoryListener = document.querySelector('#btnInventoryUpdateLRM');
              addInventoryListener.addEventListener('click', (event) => {
                let selectedAttribute = document.getElementById("riAttributes").value.split(",")
                addInventoryAttribute(selectedAttribute);
                hideSelectedOption(selectedAttribute)             
                document.getElementById("riAttributes").value = ""
                document.getElementById("btnRemoveLast").disabled = !inventoryDiagramLog.length ? true : false
              });  
              
              const hideSelectedOption = (srdSelectArr) => {
                document.querySelector(`option[value="${srdSelectArr.toString()}"]`).hidden = true
              }
              //Export PNG listener
              const exportPNGListener = document.querySelector('#btnExportPNG');
              exportPNGListener.addEventListener('click', (event) => {
                exportPNG();              
              }); 
              
              //Export JPEG listener
              const exportJPEGListener = document.querySelector('#btnExportJPEG');
              exportJPEGListener.addEventListener('click', (event) => {
                exportJPEG();              
              });        
              
              //Toggle diagram view listener
              const toggleDiagramListener = document.querySelector('#btnToggleDiagramView');
              toggleDiagramListener.addEventListener('click', (event) => {
                toggleVisibility("parentCanvas"); 
                var buttonToggleDiagram = document.getElementById("parentCanvas");
                var buttonText = document.getElementById("btnToggleDiagramView");
                if (buttonToggleDiagram.style.display === "none") {
                  buttonText.textContent = 'Show Diagram';
                } else {
                  buttonText.textContent = 'Hide Diagram';
                }                
              });       
              
              function resetSrdSelectOption(){
                let select = document.getElementById("riAttributes")
                let i=0;
                for(i=0; i<select.length; i++){
                  select.options[i].hidden = false
                }
                inventoryDiagramLog.length = 0
              } 
              //Toggle diagram clear listener
              const toggleClearnDiagramListener = document.querySelector('#btnClearDiagramView');
              toggleClearnDiagramListener.addEventListener('click', (event) => {
                var buttonToggleDiagram = document.getElementById("parentCanvas");
                var buttonText = document.getElementById("btnToggleDiagramView");
                buttonToggleDiagram.style.display = "none"
                document.querySelectorAll(`.srdBtn`).forEach((x) => {
                  x.id === "btnClearDiagramView" ? x.disabled = false : x.disabled = true
                })
                document.querySelectorAll(".inputSRD").forEach (x => x.disabled = true)
                document.getElementById("riAttributes").disabled = true
                document.getElementById("riAttributes").value = ""
                resetSrdSelectOption()
                inventoryDiagramLog = [];
                inventoryDiagramLogAllValues = [];
                clearDrawings();
                graphicsLayer.removeAll();
                document.getElementById("inpSRDRouteID").value="";
                document.getElementById("inpSRDFromDFO").value="";
                document.getElementById("inpSRDToDFO").value="";
                document.getElementById("btnRemoveLast").disabled = true         
              });              
              
              
              //Diagram URL listener
              const diagramURLListener = document.querySelector('#btnDiagramGenerateURL');
              diagramURLListener.addEventListener('click', (event) => {
                exportDiagramToURL();
              });  

              //Add condition listener
              const addConditionListener = document.querySelector('#btnAddCondition');
              addConditionListener.addEventListener('click', (event) => {
                addCondition();              
              });          
              
              //Clear condition listener
              const clearConditionListener = document.querySelector('#btnClearConditions');
              clearConditionListener.addEventListener('click', (event) => {
                clearConditions();
                let querySelectedItem = getCurrentQuerySelection()
                retrieveFeatureLayer(querySelectedItem)[0].visible = false             
              });  
              
              
              //Run Query listener
              const runQueryListener = document.querySelector('#btnRunQuery');
              runQueryListener.addEventListener('click', (event) => {
                runQuery()
              });    
              
              //Query URL listener
              const queryURLListener = document.querySelector('#btnQueryGenerateURL');
              queryURLListener.addEventListener('click', (event) => {
                exportQueryToURL();
                return
              });                
              
              //Export CSV listener
              const exportCSVListener = document.querySelector('#btnExportToCSV');
              exportCSVListener.addEventListener('click', (event) => {
                exportTableToCSV("#queryResultTable"); 
              });         
              
              //Toggle table view listener
              const toggleTableListener = document.querySelector('#btnToggleTableView');
              toggleTableListener.addEventListener('click', (event) => {
                toggleVisibility("results");           
                var buttonToggleTable = document.getElementById("results");
                var buttonText = document.getElementById("btnToggleTableView");
                if (buttonToggleTable.style.display==="none") {
                  buttonText.textContent = 'Show Table';
                } else {
                  buttonText.textContent = 'Hide Table';
                }                   
              });                
              
              //Clear Sketch
              const sketchClearListener = document.querySelector('#btnClearProject');
              sketchClearListener.addEventListener('click', (event) => {
                document.getElementById("btnRecalcProject").disabled = true
                userDrawnSketchLength=0;
                graphicsLayer.removeAll();
                linePoints.length = 0;
                setElementText("deCostResult", "")
                event.target.disabled = true
              });
              
              //Recalculate Sketch
              document.getElementById("btnRecalcProject").addEventListener("click",()=>{
                deCalculateCost()
              })
              
              //Add Event Button
              const addEventButtonListener = document.querySelector('#btnEventMap');
              addEventButtonListener.addEventListener('click', (event) => {
                document.getElementById("btnRemoveAll").disabled = false

                if (lrsButtonStatus==true) {
                  resetLRSIdentify();                  
                }
                
                var eventRoute = document.getElementById("eventRoute").value.toUpperCase();
                var eventBeginDFO = document.getElementById("eventBeginDFO").value;
                var eventEndDFO = document.getElementById("eventEndDFO").value;
                var eventColors = document.getElementById("eventColors").value;
                var eventWidth = document.getElementById("eventWidth").value;
                var eventDescription = document.getElementById("eventDescription").value;
                if(Number(eventBeginDFO) >= Number(eventEndDFO)){
                  queryResponseUI({para:`Begin DFO value is equal or greater than the End DFO value.`, header: "Event Message"}, null, height="250px", width="350px")
                  return
                }            
                getLineworkWithM(eventRoute,eventBeginDFO,eventEndDFO,eventColors,eventWidth,eventDescription);
              });           
              
              //Export Events to KML
              const exportEventsListener = document.querySelector('#btnExportToKML');
              exportEventsListener.addEventListener('click', (event) => {
                exportKML();
              }); 


              document.getElementById("btnRemoveLast").addEventListener("click", ()=>[
                removeLast()
              ])
              //Remove all events
              const removeAllEventsListener = document.querySelector('#btnRemoveAll');
              removeAllEventsListener.addEventListener('click', (event) => {
                document.getElementById("eventRoute").value = "";
                document.getElementById("eventBeginDFO").value = "";
                document.getElementById("eventEndDFO").value = "";
                document.getElementById("eventColors").value = "#000000";
                document.getElementById("eventWidth").value = "4";
                document.getElementById("eventDescription").value = "";
                document.getElementById("btnEventMap").disabled = true;
                document.getElementById("btnExportToKML").disabled = true;
                document.getElementById("btnGenerateURL").disabled = true;
                graphicsLayer.removeAll();
                setElementText("graphics", "")
                document.querySelectorAll(".eventDisable").forEach(x => x.disabled = true)
              });         
              
              //Generate URL
              const generateURLEventsListener = document.querySelector('#btnGenerateURL');
              generateURLEventsListener.addEventListener('click', (event) => {
                exportGraphicsToURL();
              });    
              
              document.getElementById("querySelectionFilter").addEventListener("change", (event) =>{
                selectQuery(event.target.value)
              })

              document.querySelector(".hamburgler").addEventListener("click", ()=>{
                if(document.getElementById("left-div").style.display === "block"){
                  document.getElementById("left-div").style.display = "none"
                  return 
                }
                document.getElementById("left-div").style.display = "block"
                viewTabletInteraction()
                return
              })

              function viewTabletInteraction(){
                view.on("pointer-down",() =>{
                  document.getElementById("left-div").style.display = "none"
                })
              }
              
              //End listeners---------------------------------------------------
              
              //Control buttons and tabs----------------------------------------
              function resetToolButtons(btnId){
                let buttonsId = [{id:"measureButton", action: () => turnOffMeasurement()}, {id:"lrsButton", action: () => turnOffLRS()}, {id:"print", action: () => turnOffPrint()}, {id:"legend", action: () => turnOffLegend()}]
                buttonsId.forEach((x) => {
                  if(x.id !== btnId){
                    x.action()
                  }
                })
              }

              function resetAllTabs() {
                resetButton("baseMaps");
                resetButton("dataQuery");                
                resetButton("roadwayDiagram");
                resetButton("eventForm");
                resetButton("graphicSketch");
                document.getElementById("mapTab").style.display = "none";
                document.getElementById("queryTab").style.display = "none";
                document.getElementById("diagramTab").style.display = "none"; 
                document.getElementById("eventTab").style.display = "none";                
                document.getElementById("sketchTab").style.display = "none";
                document.getElementById("results").style.display = "none";
                document.getElementById("parentCanvas").style.display = "none";
                document.getElementById("viewDiv").style.cursor = "default"
                numberOfAttributes=0;
                inventoryDiagramLog = [];
                inventoryDiagramLogAllValues = [];
                removeDrawEvent()
                document.getElementById("btnClearProject").disabled = true
                let ri = retrieveFeatureLayer("RoadInventory")[0]
                let bi = retrieveFeatureLayer("Bridges")[0]
                setInvisible(ri, ri.name, ri.name)
                setInvisible(bi, bi.name, bi.name)

                //resetBaseMapItem(bi.id)
                userDrawnSketchLength=0;
                graphicsLayer.removeAll();
                resetLRSIdentify();
                linePoints.length = 0;
                setElementText("deCostResult", "")
                setElementText("graphics", "")
              }
              
              function resetAllTools() {
                resetButton("measureButton");
                resetButton("lrsButton"); 
              }      
              
              function resetQueryTool(){

              }
              function clearAndResetMap() {
                setZoomAndLocation([31.5,-100,6]);
                activateButton("baseMaps");
                //Reset Diagram

                document.getElementById("parentCanvas").style.display = "none";
                numberOfAttributes=0;    
                inventoryDiagramLog = [];
                inventoryDiagramLogAllValues = [];                
                
                //Reset Table
                document.getElementById("results").style.display = "none";                
                  
                //reset buttons and div
                clearInnerHTML("mapClickResults");
                resetAllTools();
                resetAllTabs()
                activateButton("baseMaps");
                document.getElementById("mapTab").style.display = "block";
                measurementWidget.visible = false;
                graphicsLayer.removeAll();
                graphicsLayerLRSIdentify.removeAll();
                document.getElementById("viewDiv").style.cursor = "default"
                resetAllTabs
                clearOverlay()                
              }       
              
              function resetAllBaseMapItems() {
                basemapAll.forEach((x) => {
                  resetBaseMapItem(x.name)
                  x.featLayer.visible = false
                })
                return
              }               

              function resetButton(theElement) {
                document.getElementById(theElement).style.backgroundColor = "";
                document.getElementById(theElement).style.color = "black";
                document.getElementById(theElement).style.textDecoration = "";
                document.getElementById(theElement).style.borderBottom = "";  
                return
              }              
              
              function activateButton(theElement) {
                document.getElementById(theElement).style.backgroundColor = "rgba(32, 78, 112, .8)";
                document.getElementById(theElement).style.color = "white";         
                return
              }

              function activateToolButton(theElement){
                document.getElementById(theElement).style.backgroundColor = "#204e70";
                document.getElementById(theElement).style.color = "white";  
                return
              }
              
              function resetBaseMapItem(theElement) {
                document.getElementById(theElement).style.color = "black";
                document.getElementById(theElement).style.fontWeight = "normal";
                document.getElementById(theElement).style.borderLeft = ""
                document.getElementById(theElement).style.paddingLeft = "1rem"
                document.getElementById(theElement).style.backgroundColor = ""
                return
              }
              
              function activateBaseMapItem(theElement) {
                document.getElementById(theElement).style.borderLeft = "6px solid #14375A"
                document.getElementById(theElement).style.paddingLeft = ".6rem"
                document.getElementById(theElement).style.backgroundColor = "rgba(20,55,90,.2)"
                return
              }
              
              function clearInnerHTML(theElement) {
                document.getElementById(theElement).innerHTML = "";
                return
              }
              //End buttons and tabs--------------------------------------------
              
              //Jump to Google Maps---------------------------------------------
              function openGoogleMaps() {
                var ctr = view.center;
                var lat = ctr.latitude;
                var lon = ctr.longitude;
                var level = view.zoom + 1;
                window.open("https://www.google.com/maps/@"+lat+","+lon+","+level+"z");
              }      
              //End Google Maps-------------------------------------------------
              
              //Create csv export, table id must have the "#"-------------------
              function exportTableToCSV(theTable) {
                  const table = document.querySelector(theTable);
                  if (!table) {
                      alert('There is no table to export.');
                      return;
                  }
              
                  const rows = Array.from(table.rows);
                  const csv = [];
              
                  rows.forEach(row => {
                      const rowData = [];
                      Array.from(row.cells).forEach(cell => rowData.push(`"${cell.textContent.replace(/"/g, '""')}"`));
                      csv.push(rowData.join(','));
                  });
              
                  downloadCSV(csv.join('\n'), 'table_export.csv');
              }
              //End CSV Export--------------------------------------------------
              
              //Execute the csv download----------------------------------------
              function downloadCSV(csv, filename) {
                  const csvFile = new Blob([csv], { type: 'text/csv' });
                  const downloadLink = document.createElement('a');
              
                  downloadLink.download = filename;
                  downloadLink.href = URL.createObjectURL(csvFile);
                  downloadLink.style.display = 'none';
              
                  document.body.appendChild(downloadLink);
                  downloadLink.click();
                  document.body.removeChild(downloadLink);
              }         
              //End download CSV------------------------------------------------
              
              //Read parameters from the URL------------------------------------
              function defaultbasemap(){
                activateBaseMapItem("lightgray")
                lightGrayLayer.visible = true
                return
              }

              function readUrlParams() {
                //Graphics Layer User Lines and Points
                graphicsLayer = new GraphicsLayer();
                map.add(graphicsLayer);               
                
                //Graphics Layer LRS Identify
                graphicsLayerLRSIdentify = new GraphicsLayer();
                map.add(graphicsLayerLRSIdentify);                 
                
                let url = window.location.search
                if(!url.length){
                  resetTabInput("eventTab")
                  resetTabInput("diagramTab")
                  queryCheckOnLoad()
                  eventCheckOnLoad()
                  SRDCheckOnLoad()
                  resetAllBaseMapItems()
                  activateButton("baseMaps");
                  document.getElementById("mapTab").style.display = "block";
                  defaultbasemap()
                  return
                }

                urlParams = getURLParams(url);
                basemapParam = urlParams.get("map") ?? "lightgray";
                overlayParam = urlParams.get("overlays");
                tabParam = urlParams.get("tab");
                locationParam = urlParams.get("location");
                eventParam = urlParams.get("event");
                pointParam = urlParams.get("point");
                queryParam = urlParams.get("query");
                diagramParam = urlParams.get("diagram");
                urlParams.get("coords") ? locationParam = `${urlParams.get("coords")}, ${urlParams.get("z")}` : null
                let queryType = urlParams.get("queryType")

                if(overlayParam){
                  let splitOverlay = overlayParam.split(",")
                  splitOverlay.forEach((urlOverlay) => {
                    if(!mainTOCLayers.includes(urlOverlay)){
                      appendChildToOverlayList(urlOverlay, "FeatureLayer", false)
                    }
                    
                    let layerId = retrieveFeatureLayer(urlOverlay)
                    let returnId = itemArr.find(overlay => overlay.name === urlOverlay)
                    layerId.forEach((featLayer) => {
                      featLayer.when((f) =>{
                        setIsVisible(f, returnId, urlOverlay)
                        resetBaseMapItem("CLEAR")
                        getActiveLayers(view.zoom)
                        document.getElementById(`dwnloadBtn${urlOverlay}`).style.display = "block"
                      })
                    })


                  })
                }


                if(basemapParam){
                  resetAllBaseMapItems()
                  basemapAll.find(x => x.name === basemapParam).featLayer.visible = true
                  activateBaseMapItem(basemapParam)
                }
                
                //Set map zoom and location if provided
                if (locationParam) {
                  setZoomAndLocation(locationParam.split(","));
                }
                
                //Add the event if provided
                if (eventParam) {
                  inputEventListner("eventRoute")
                  var eventParam = eventParam.replace(/%23/g, "#");
                  const eventArray = eventParam.split('|');
                  eventArray.forEach((x) => {
                    let [route, bDfo, eDfo, color, width, desc] = x.split(",")
                    document.getElementById("eventRoute").value = route
                    document.getElementById("eventBeginDFO").value = bDfo
                    document.getElementById("eventEndDFO").value = eDfo
                    document.getElementById("eventColors").value = color
                    document.getElementById("eventWidth").value = width
                    document.getElementById("eventDescription").value = desc

                    getLineworkWithM(route,bDfo,eDfo,color,width,desc);
                  })

                  eventCheckOnLoad()
                  let isAllDisabled = disableQuery()
                  checkFieldStatus("#eventTab", isAllDisabled)                      
                }
                
                //Add the event if provided
                if (pointParam) {
                  const pointArray = pointParam.split('|');
                  // Output the individual arrays
                  for (let i = 0; i < pointArray.length; i++) {
                    const individualArray = pointArray[i].split(',');
                    mapThePoint(individualArray[0],individualArray[1],individualArray[2],individualArray[3],individualArray[4]);
                  }                  
                }       
                
                if (queryParam) {
                  setElementText("conditions", "")
                  const queryArray = queryParam.split('|');
                  const queryFields = queryArray[0].split(',');
                  const queryConditions = queryArray[1].split(' AND ');
                  var operators = ['=', '<', '>', '!=', '<=', '>='];                  
                  for (var i = 0; i < queryConditions.length; i++) {
                    var text = queryConditions[i];
                    var foundOperator = operators.find(function(operatorVal) {
                      return text.includes(operatorVal);
                    });  
                    
                    var arrayConditionsParts = [];
                    if (foundOperator) {
                      arrayConditionsParts = text.split(foundOperator);
                      arrayConditionsParts.splice(1, 0, foundOperator);
                      var field = arrayConditionsParts[0];
                      var operator = arrayConditionsParts[1];
                      var value = arrayConditionsParts[2];
                      conditions.push({field,operator,value});
                      createConditionVar(`${field} ${operator} ${value}`)
                      //Add to the display 
                    }                    
                  }
                  

                  let returnFeatureLayer = retrieveFeatureLayer(queryType)
                  let querySelection = document.getElementById("querySelectionFilter").children[1].children.namedItem(queryType)
                  querySelection.checked = true

                  view.whenLayerView(returnFeatureLayer[0]).then(function(layerView) {
                      var selectElement = document.getElementById("outputFields");
                      for (var i = 0; i < selectElement.options.length; i++) {
                        var option = selectElement.options[i];
                        if (queryFields.includes(option.value)) {
                          option.selected = true;
                        }
                      }
                      setLayerDefinitionExpression(returnFeatureLayer[0]);
                  });
                  queryCheckOnLoad()
                  let isAllDisabled = disableQuery()
                  checkFieldStatus("#queryTab", isAllDisabled)                    
                }
                
                if (diagramParam) {
                  inputEventListner("inpSRDRouteID")
                  const diagramFullArray = diagramParam.split('|');
                  document.getElementById("btnRemoveLast").disabled = diagramFullArray[1] ? false : true
                  const diagramInputs = diagramFullArray[0].split(',');
                  document.getElementById("inpSRDRouteID").value = diagramInputs[0];
                  document.getElementById("inpSRDFromDFO").value = diagramInputs[1];
                  document.getElementById("inpSRDToDFO").value = diagramInputs[2];
                  
                  //Get specifics for each attribute in the diagram
                  const diagramInventoryInputs = diagramFullArray[1].split(',');
                  const selectElement = document.getElementById("riAttributes");
                  const selectOptions = selectElement.options;
                  
                  for (let i = 0; i < selectOptions.length; i++) {
                    const optionValue = selectOptions[i].value;
                    const optionValuesArray = optionValue.split(",");
                    const lastValue = optionValuesArray[optionValuesArray.length - 1];
                  
                    if (diagramInventoryInputs.includes(lastValue)) {
                      hideSelectedOption(optionValuesArray)
                      inventoryDiagramLogAllValues.push(optionValuesArray);
                    }
                  }
                  
                  //Start the build diagram process
                  checkLRMInputs();
                  SRDCheckOnLoad();
                  let isAllDisabled = disableQuery()
                  checkFieldStatus("#diagramTab", isAllDisabled)                
                }


                //Activate tab if provided
                if (tabParam=="maps") {
                  activateButton("baseMaps");
                  document.getElementById("mapTab").style.display = "block";
                } else if (tabParam=="query") {
                  activateButton("dataQuery");
                  document.getElementById("queryTab").style.display = "block";                  
                } else if (tabParam=="event") {
                  activateButton("eventForm");
                  document.getElementById("eventTab").style.display = "block";                  
                } else if (tabParam=="diagram") {
                  activateButton("roadwayDiagram");
                  document.getElementById("diagramTab").style.display = "block"; 
                } else if (tabParam=="sketch") {
                  activateButton("graphicSketch");
                  document.getElementById("sketchTab").style.display = "block";                  
                } else {
                  activateButton("baseMaps");
                  document.getElementById("mapTab").style.display = "block";                  
                }
                return
              }      
              //End URL parameters----------------------------------------------
     
              //Draw map points-------------------------------------------------
              function mapThePoint(theLat,theLong,theColor,theSize,theDescription) {
                var inputPoint = new Point({
                  latitude: theLat,
                  longitude: theLong
                });               
                
                //Convert the Point to Web Mercator spatial reference
                var webMercatorPoint = webMercatorUtils.geographicToWebMercator(inputPoint);
                
                // Create a point graphic with the specified properties
                var pointGraphic = new Graphic({
                  geometry: webMercatorPoint,
                  symbol: {
                    type: "simple-marker",
                    color: theColor,
                    size: theSize,
                    outline: {
                      color: theColor,
                      width: "1px"
                    }
                  },
                  popupTemplate: new PopupTemplate({
                    title: theLat + "," + theLong,
                    content: theDescription
                  }) 
                });
                
                // Add the point graphic to the graphics layer
                graphicsLayer.add(pointGraphic);                
              }
              //End draw points-------------------------------------------------

              //Set map zoom (30,-100,10)---------------------------------------
              function setZoomAndLocation(theLocation) {
                  var point = new Point({
                    x: theLocation[1],
                    y: theLocation[0],
                    spatialReference: new SpatialReference({
                      wkid: 4326
                    })
                  });
                  view.center = point;
                  view.zoom = theLocation[2];                 
              }
              //End set map zoom------------------------------------------------
              
              //Remove startup message in the conditions element
              function removeStartUpCondition() {
                  var ulElement = document.getElementById('conditions');
                  var firstLiElement = ulElement.querySelector('li:first-child');
                  if (firstLiElement && firstLiElement.textContent === 'Conditions listed here') {
                    ulElement.removeChild(firstLiElement);
                  }                  
              }
              
              //Add startup message to conditions element
              function addStartUpCondition() {
                  const li = document.createElement('li'); 
                  document.getElementById("outputFields").disabled = true
              }

              function resetFeatureLayer(roadId){
                let featLayer = retrieveFeatureLayer(roadId)
                featLayer[0].visible = false
                featLayer[0].definitionExpression = ""
                clearConditions()
                //toggleLayer(featLayer[0].name)
              }

              function createQueryBtn(btn, b){
                btn.id = b.id
                btn.className = "spmMainBtn"
                btn.textContent = b.btnText
                btn.onclick = () => {
                  b.btnClick()
                }
                return btn
              }

              function queryResponseUI(text, btnType, height, width){
                let getTemplate = document.getElementById("queryTemplate")
                let templateClone = getTemplate.content.cloneNode(true)
                let div = templateClone.querySelectorAll("div")

                let innerModal = document.createElement("div")
                let h2 = document.createElement("h2")
                let textArea = document.createElement("div")
                innerModal.classList.add("overlay")
                let p = document.createElement("p")
                p.id = "queryMessagePara"
                textArea.id = "previewUrl"
                h2.id = "modalHeader"

                
                textArea.textContent = text.url
                textArea.disabled = true
                text.url ? textArea.style.display = "block" : textArea.style.display = "none"

                h2.textContent = text.header
                p.innerHTML = text.para
                div[0].appendChild(h2)
                div[0].appendChild(p)
                div[0].appendChild(textArea)
                div[0].classList.add("queryStatus")
                let btns;
                [{btnText: "CLOSE", id: "queryMessageBtn", btnClick: ()=>{removeQueryResponseUI()}}, {btnText: "COPY URL", id: "copyURL", btnClick: ()=>{navigator.clipboard.writeText(text.url)}}].forEach((b) =>{
                  let btns = document.createElement("button")
                  div[0].appendChild(createQueryBtn(btns, b))
                })

                if(btnType){
                  let coordBtn = document.createElement("button")
                  coordBtn.id = "copyCoord"
                  coordBtn.textContent = btnType.name
                  coordBtn.className = "spmSecondaryBtn"
                  coordBtn.onclick = () =>{
                    navigator.clipboard.writeText(btnType.coord)
                    document.getElementById("copyURL").style.visibility = "visible"
                  }
                  div[0].appendChild(coordBtn)
                }
                
                
                document.body.appendChild(innerModal)
                document.body.appendChild(templateClone)
              }

              const removeQueryResponseUI = () => {
                document.querySelector(".queryStatus").remove()
                document.querySelector(".overlay").remove()
                
              }
              
              //Query form functions--------------------------------------------
              function updateQuery(){
                let selectedId = getCurrentQuerySelection()
                if(!conditions.length){
                  document.querySelectorAll(".qryBtn").forEach(x => x.disabled = true)
                  document.getElementById("outputFields").disabled = true
                  document.getElementById("results").style.display = "none"
                  document.getElementById("value").value = ""
                  resetFeatureLayer(selectedId)
                  return
                }
                runQuery()
                return
              } 

              function createConditionVar(currentOpt){
                const span = document.createElement('span');
                const spanDiv = document.createElement("div")
                span.className = "queryCondition"
                span.id = currentOpt
                    
                const queryBtnDiv = document.createElement("div")
                const rmvButton = document.createElement("button")

                spanDiv.appendChild(document.createTextNode(currentOpt))
                spanDiv.style.width = "80%"
                spanDiv.style.overflowWrap = "break-word"
                rmvButton.className = "esri-icon-close-circled rmvQueryBtn"
                rmvButton.onclick = () =>{
                  document.getElementById(currentOpt).remove()
                  let index = conditions.findIndex(x => Object.values(x).toString() === currentOpt.split(" ").toString())
                  conditions.splice(index, 1)
                  updateQuery()
                }

                queryBtnDiv.appendChild(rmvButton)
                span.appendChild(rmvButton)
                span.appendChild(spanDiv)
                document.getElementById('conditions').appendChild(span);
                document.getElementById("outputFields").disabled = false
                return
              }

              function addCondition() {
                  removeStartUpCondition();
                  const field = document.getElementById('field').value;
                  const operator = document.getElementById('operator').value;
                  const value = document.getElementById('value').value;
                  let currentOperation = `${field} ${operator} ${value}`;
                  let isExist = conditions.find(x => Object.values(x).toString() === currentOperation.split(" ").toString())
                  if(!isExist){
                    conditions.push({ field, operator, value });
                    createConditionVar(currentOperation)
                    return
                  }
                return    
              }  

              function clearConditions() {
                  conditions = [];
                  document.getElementById("value").value = ""
                  setElementText("conditions", "")
                  setElementText("results", "")
                  document.getElementById("results").style.display = "none";
                  document.getElementById("btnToggleTableView").disabled = true;
                  document.getElementById("btnExportToCSV").disabled = true;
                  document.getElementById("btnQueryGenerateURL").disabled = true;
                  document.getElementById("btnRunQuery").disabled = true;
                  document.getElementById("btnAddCondition").disabled = true;
                  addStartUpCondition();
              }              
              
              async function runAssetQuery(where, outFields, featLayer){
                document.getElementById("btnRunQuery").textContent = "Loading..."
                document.getElementById("btnRunQuery").disabled = true
                query = new Query();
                query.where = where;
                query.outFields = [outFields];
                query.returnGeometry = true;
                query.supportsPagination = true;
                try{
                  
                  let layerView = await view.whenLayerView(featLayer)
                  let returnQuery = await layerView.layer.queryFeatures(query)
                  layerView.layer.definitionExpression = where;
                  if(!returnQuery.features.length){
                    queryResponseUI({para: `Welp, no items were returned.  Update your query and try again.`, header:"Query Message"}, null, height="250px", width="350px")
                    document.getElementById("btnRunQuery").textContent = "Run Query"
                    document.getElementById("btnRunQuery").disabled = false
                    return
                  }

                  queryTableResults = returnQuery
                  document.getElementById("btnToggleTableView").disabled = false
                  document.getElementById("btnClearConditions").disabled = false
                  document.getElementById("btnExportToCSV").disabled = false
                  document.getElementById("btnQueryGenerateURL").disabled = false
                  makeTableFromService(returnQuery);
                  
                  document.getElementById("btnRunQuery").textContent = "Run Query"
                  document.getElementById("btnRunQuery").disabled = false
                }
                catch(err){
                  queryResponseUI({para:`Welp, Invalid query. Check your parameters and retry.`, header: "Query Message"}, null, height="250px", width="350px") 
                  document.getElementById("btnRunQuery").textContent = "Run Query"
                  document.getElementById("btnRunQuery").disabled = false
                  //removeQueryResponseUI()
                }
              }

              function runQuery(){
                let getQueryFeatLayer = retrieveFeatureLayer(document.querySelector(`input[name="featQuery"]:checked`).value)
                setLayerDefinitionExpression(getQueryFeatLayer[0]);
                return 
              }

              async function setLayerDefinitionExpression(featLayer) {
                resetLRSIdentify();
                document.getElementById("btnRunQuery").textContent = "Loading..."
                document.getElementById("btnRunQuery").disabled = true
                var outputFieldsSelect = document.getElementById("outputFields");
                var outputFieldList = Array.from(outputFieldsSelect.selectedOptions).map(option => option.value).join(',');
                var queryWhere = conditions.map(condition => `${condition.field} ${condition.operator} '${condition.value}'`).join(' AND ')
                await runAssetQuery(queryWhere, outputFieldList, featLayer)

                let queryExtentComplete = await featLayer.queryExtent(query)
                if(!queryExtentComplete.extent){
                  return
                }
                featLayer.visible = true
                goToQuery(queryExtentComplete, featLayer)
                
                  //check extents
                return
              }

              function goToQuery(queryReturnExtent, layer){
                view.whenLayerView(layer).then(layerView => {
                  view.goTo(queryReturnExtent.extent)
                  document.getElementById("btnToggleTableView").textContent = "Hide Table"
                  document.getElementById("btnRunQuery").textContent = "Run Query"
                  document.getElementById("btnRunQuery").disabled = false
                  document.querySelectorAll(".exportBtn").forEach(x => x.disabled = false)
                })
                return 
              }

              function getRowInfo(event){
                let evt = event.target;
                let test = []
                while(evt){
                  test.push(evt.innerHTML)
                  evt = evt.nextElementSibling
                }
                let comparteArr = test.map((x) => {
                  if(!x){
                    return null
                  }
                  return x
                })

                let rowArr = []
                let returnResult = queryTableResults.features.filter((x) => {
                  for(let i in x.attributes){
                    if(typeof(x.attributes[i]) === "number"){
                      x.attributes[i] = x.attributes[i].toString()
                    }
                  }
              
                  if(JSON.stringify(comparteArr) === JSON.stringify(Object.values(x.attributes))){
                    rowArr.push(x.geometry)
                  }
                  
                })
                view.goTo(rowArr)
              }

              async function makeTableFromService(dataArray) {
                  let makeTablePromise = new Promise((res,rej) => {
                    var fieldNames = [];
                    for(var i=0; i<dataArray.fields.length; i++) {
                        fieldNames.push(dataArray.fields[i].name);
                    }
              
                  // Create a table to display the data
                    var table = document.createElement('table');
                    table.classList.add("queryTableResults"); 
                    table.setAttribute("id", "queryResultTable");
                  
                    var header = document.createElement('tr');  
                  
                    for (var i=0; i<fieldNames.length; i++) {
                        var th = document.createElement('th');
                        th.classList.add("queryTblHeader");
                        th.textContent = fieldNames[i];
                        th.addEventListener('click', onHeaderClick); // Add click event listener
                        header.appendChild(th);
                    }
                    table.appendChild(header);
                  
                  //Build the table
                    for(var i=0; i<dataArray.features.length; i++) {
                        var row = document.createElement('tr');
                        row.addEventListener("click", (evt)=>{
                          getRowInfo(evt)
                        })
                        for (var x in dataArray.features[i].attributes) {
                            
                            td = document.createElement('td');
                            td.textContent = dataArray.features[i].attributes[x];
                            td.classList.add("queryTblData");
                            row.appendChild(td);                        
                        }
                        table.appendChild(row);
                    }
                    var results = document.getElementById('results');
                    results.innerHTML = ''; // Clear previous results
                    results.appendChild(table);
                    document.getElementById("results").style.display = "block";
                    res("table created")
                  })

                  return await makeTablePromise
              }               
              
              function sortTable(columnIndex, isAscending) {
                  const table = document.querySelector('#results table');
                  const rows = Array.from(table.rows).slice(1); // Exclude header row
              
                  rows.sort((a, b) => {
                      const aValue = a.cells[columnIndex].textContent;
                      const bValue = b.cells[columnIndex].textContent;
              
                      if (aValue === bValue) {
                          return 0;
                      }
              
                      return (aValue < bValue ? -1 : 1) * (isAscending ? 1 : -1);
                  });
              
                  for (const row of rows) {
                      table.appendChild(row);
                  }
              }
              
              function onHeaderClick(event) {
                  const th = event.target;
                  const isAscending = th.getAttribute('data-sort-order') !== 'asc';
                  const columnIndex = Array.from(th.parentElement.children).indexOf(th);
              
                  sortTable(columnIndex, isAscending);
              
                  // Update the sort order attribute
                  Array.from(th.parentElement.children).forEach(header => header.removeAttribute('data-sort-order'));
                  th.setAttribute('data-sort-order', isAscending ? 'asc' : 'desc');
              }              
              //End query form functions----------------------------------------
              
              //view event to track drawing-------------------------------------
              function sketchDraw(){
                document.getElementById("viewDiv").style.cursor = "crosshair"
                draw = view.on("click", function(event) {
                  if(document.getElementById("sketchTab").style.display === "block"){
                    if(measurementWidget.visible === false){
                      var testSketchDiv = document.getElementById("sketchTab");
                      document.getElementById("btnClearProject").disabled = false
                      document.getElementById("btnRecalcProject").disabled = false
                      let point = view.toMap({x: event.x, y: event.y});

                      //add graphic to map
                      var pointGraphic = new Graphic({
                        geometry: point,
                          symbol: {
                            type: "simple-marker",
                            color: "red",
                            size: "10px",
                            outline: {
                            color: "red",
                            width: "2px"
                          }
                        }
                      });      
                    
                      graphicsLayer.add(pointGraphic);                  
                        
                      linePoints.push([point.longitude,point.latitude]);
                      if (linePoints.length > 1) {
                        addLine(linePoints);
                      }
                    }
                 
                    event.stopPropagation() 
                  }
                  
                });  
              }
              
              function removeDrawEvent(){
                document.getElementById("viewDiv").style.cursor = "default"
                draw?.remove()
                draw = null
                
              }
              //end view event--------------------------------------------------
              
              //Adding user drawn lines to the map------------------------------
              function addLine(points) {
                var line = new Polyline({
                  paths: [points],
                  spatialReference: { wkid: 4326 }
                });
        
                userDrawnSketchLength = geometryEngine.geodesicLength(line, "miles").toFixed(3);
        
                lineGraphic = new Graphic({
                  geometry: line,
                  symbol: {
                    type: "simple-line",
                    color: "red",
                    width: 4
                  }
                });
        
                graphicsLayer.add(lineGraphic);
                deCalculateCost()
              } 
              //End user drawn lines--------------------------------------------
              
              //Sketch Cost-----------------------------------------------------
              function deCalculateCost() {
        				if (userDrawnSketchLength > 0) {
        					//Nothing
        				} else {
        					alert("Please draw a line before calculating costs.");
        					return;
        				}
        
        				var deProjectType = document.getElementById("selPrjType").value;
        				var deAreaType = document.getElementById("selPrjAreaType").value;
        				var deRouteType = document.getElementById("selPrjRouteType").value;
        				var deDivided = document.getElementById("selPrjDividedType").value;
        				var deFrontageRoads = document.getElementById("selPrjFrontageRoads").value;
        				var deLanes = document.getElementById("txtPrjLanes").value;
        				var deProjectLength = Math.round(userDrawnSketchLength * 1000) / 1000;
        
        				if (deLanes < 1) {
        					alert("Number of Lanes must be greater than 0.");
        					return;
        				}
        
        				if (deRouteType == "E") {
        					deDivided = "H";
        				}
        
        				var userProjectInput = deProjectType + deAreaType + deRouteType + deDivided;
        				var codeArray = new Array("ADFH","ADFI","BDFH","BDFI","ADGH","ADGI","BDGH","BDGI","ADEH","BDEH","ACFH","ACFI","BCFH","BCFI","ACGH","ACGI","BCGH","BCGI","ACEH","BCEH");
        				var costArray = new Array(2891181,1523096,679775,410606,1567558,1142895,743221,527346,2500000,585985,3307443,1424801,883591,742257,2948087,1413481,1213519,853382,5463629,917134);
        				var prjCostPerMile;
        
        				var i;
        				for (i = 0; i < 20; i++) {
        					if (userProjectInput == codeArray[i]) {
        						prjCostPerMile = costArray[i];
        					}
        				}
        
        				var totalRoadTypeCost = prjCostPerMile * deLanes * deProjectLength;
        				var totalFrontageRoadCost = 0;
        
        				if (deFrontageRoads == "2") {
        					totalFrontageRoadCost = 1250000 * deProjectLength * 4;
        				} else {
        					totalFrontageRoadCost = 0;
        				}
        
        				//Summing total project cost and writing to output
        				var totalProjectCost = totalRoadTypeCost + totalFrontageRoadCost;
        				totalProjectCost = Math.round(totalProjectCost / 1000) * 1000;
                setElementText("deCostResult", "<u>Project Length</u>: <br>" + "<b>" + deProjectLength + "</b>" + " miles<br><br><u>Estimated Construction Cost</u>: <br>$" +	"<b>" + totalProjectCost.toLocaleString() + "</b>")
        			}  
        			//End Sketch Cost-------------------------------------------------
              
              //Export KML------------------------------------------------------
              function exportKML() {
                var graphics = graphicsLayer.graphics.toArray();
                
                var kml = '<?xml version="1.0" encoding="UTF-8"?>' +
                  '<kml xmlns="http://www.opengis.net/kml/2.2">' +
                  '<Document><visibility>1</visibility><open>1</open>';
        
                graphics.forEach(function (graphic) {
                  var geometry = graphic.geometry;
                  var symbol = graphic.symbol;
                  var title = graphic.popupTemplate.title;
                  var content = graphic.popupTemplate.content;
        
                  // Extract line color and width from symbol if it is a SimpleLineSymbol
                  var lineColor, lineWidth;
                  if (symbol instanceof SimpleLineSymbol) {
                    lineColor = symbol.color.toHex();
                    lineWidth = symbol.width;
                  }
                  
                  // Remove the "#" symbol
                  var stringWithoutHash = lineColor.substring(1);
                  
                  // Extract the parts to be swapped
                  var part1 = stringWithoutHash.substring(0, 2); // "00"
                  var part2 = stringWithoutHash.substring(2, 4); // "bf"
                  var part3 = stringWithoutHash.substring(4); // "ff"
                  
                  // Reorder the parts
                  var reorderedString = part3 + part2 + part1;
                  
                  // Append "7f" to the front of the reordered string
                  lineColor = "7f" + reorderedString;                  
        
                  // Build KML for the graphic
                  var graphicKML = '<Placemark>' +
                    '<name>' + title + '</name>' +
                    '<description>' + content + '</description>';
                    
                  // Add line color and width to KML
                  if (lineColor && lineWidth) {
                    graphicKML += '<Style>' +
                      '<LineStyle>' +
                      '<color>' + lineColor + '</color>' +
                      '<width>' + lineWidth + '</width>' +
                      '</LineStyle>' +
                      '</Style>';
                  }                    
        
                  // Add geometry information to KML
                  if (geometry.type === 'polyline') {
                    graphicKML += '<LineString>' + '<coordinates>';
                    
                    geometry.paths[0].forEach(function (vertex) {
                      // Convert Web Mercator coordinates to lat/long
                      var lngLat = webMercatorUtils.xyToLngLat(vertex[0], vertex[1]);
                      var lng = lngLat[0].toFixed(6);
                      var lat = lngLat[1].toFixed(6);
              
                      graphicKML += lng + ',' + lat + ' ';
                    });                    
                    graphicKML += '</coordinates>' + '</LineString>';
                  }
                  graphicKML += '</Placemark>';
                  kml += graphicKML;
                });
        
                kml += '</Document>' + '</kml>';
                downloadFile('export.kml', kml);
              }
              
              // Function to download the KML file
              function downloadFile(filename, content) {
                var element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
                element.setAttribute('download', filename);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
              }
              //End KML Export--------------------------------------------------
              

              function removeLast(){
                drawRectangle(10,attributeStartY+(numberOfAttributes*spacePerAttribute)-90, rulerWidth+45,60,"#FFFFFF"); 
                numberOfAttributes -= 1
                let removedItem = inventoryDiagramLog.pop()
                let list = document.querySelector("#riAttributes").options
                for(let i in list){
                  try{
                    if(list[i].value.includes(`${removedItem}`)){
                      list[i].hidden = false
                    }
                  }
                  catch{
                    //undefined
                  }
                }
                document.getElementById("btnRemoveLast").disabled = !inventoryDiagramLog.length ? true : false
              }

              //Check diagram fields--------------------------------------------
              async function checkLRMInputs() {
                diagramTitle = document.getElementById("inpSRDRouteID").value.toUpperCase();
                diagramBeginDFO = Number(document.getElementById("inpSRDFromDFO").value);
                diagramEndDFO = Number(document.getElementById("inpSRDToDFO").value);
                let nonRouteArr = ["LG", "RG"]
                for(let x=0; x < nonRouteArr.length; x++){
                  if(diagramTitle.includes(nonRouteArr[x])){
                    queryResponseUI({para:`Only use KG or centerline Route IDs (i.e IH0035-KG)`, header: "SRD Message"}, null, height="250px", width="350px")
                    document.getElementById("btnUpdateLRM").textContent = "Create Diagram"
                    document.getElementById("btnUpdateLRM").disabled = false
                    return
                  }
                }

                //Check that Route input is not empty
                if(diagramEndDFO <= diagramBeginDFO){
                  queryResponseUI({para:`Begin DFO value is equal or greater than the End DFO value.`, header: "SRD Message"}, null, height="250px", width="350px")
                  document.getElementById("btnUpdateLRM").textContent = "Create Diagram"
                  document.getElementById("btnUpdateLRM").disabled = false
                  return
                }
                
                //Clearing the LRS identify tools if they area activated
                if (lrsButtonStatus==true) {
                  resetLRSIdentify();
                }              
                
                graphicsLayer.removeAll();             
                let lineworkResp = await getLineworkWithM(diagramTitle,diagramBeginDFO,diagramEndDFO,"#000000",6,"Route: "+diagramTitle+"<br>From DFO: "+diagramBeginDFO+"<br>To DFO: "+diagramEndDFO);
                //Building the Diagram
                if(lineworkResp){
                  return
                }
                await buildDiagram(diagramTitle,diagramBeginDFO,diagramEndDFO);
                return
                //Adding the event to the map
                
              }         

              async function buildDiagram(diagramTitle,diagramBeginDFO,diagramEndDFO) {
                var canvasParentDiv = document.getElementById("parentCanvas");
                canvasParentDiv.style.display = "block";
                
                // Set the canvas element's dimensions
                var canvas = document.getElementById("myCanvas");
                canvas.width = canvasParentDiv.clientWidth;
                canvas.height = canvasParentDiv.clientHeight; 
                
                maxAttributesOnPage = Math.floor((canvas.height-attributeStartY)/(spacePerAttribute+5)); 
                numberOfAttributes=0;
                
                // Get the 2D rendering context of the canvas
                var context = canvas.getContext("2d");
                
                //Draw neatline
                drawPolygon([[0,0],[canvas.width,0],[canvas.width,canvas.height],[0,canvas.height],[0,0]],2,"#FFFFFF","#D3D3D3");
                
                //Draw header
                drawPolygon([[0,0],[canvas.width,0],[canvas.width,30],[0,30],[0,0]],1,"#14375A","#4682B4");
                
                //Ruler variables
                rulerY = 90; // Vertical position of the ruler
                rulerHeight = 20; // Height of the ruler
                rulerMargin = 35; // Margin from left and right borders
                rulerLength = (diagramEndDFO-diagramBeginDFO).toFixed(3); // Length of the ruler in miles  
                rulerWidth = canvas.width - rulerMargin * 2;
                pixelsPerMile = rulerWidth / rulerLength;
                
                //Draw ruler
                drawRectangle(rulerMargin,rulerY,rulerWidth,rulerHeight,"#D3D3D3"); 
                
                // Calculate upper label positions
                labelY = rulerY - rulerHeight / 2 - 20; // Y position for upper labels
                labelPositions = [rulerMargin, rulerMargin + rulerWidth / 4, rulerMargin + rulerWidth / 2, rulerMargin + rulerWidth * 3 / 4, canvas.width - rulerMargin]; // X positions for upper labels
                labelFactor = roundToDecimalPlace((rulerLength/4),3);
                labelValue = diagramBeginDFO;
                 
                //Diagram heading text
                drawText("TxDOT",10,22,"#FFFFFF","18");
                drawTextCenter(diagramTitle,labelPositions[2],22,"#FFFFFF","18");
                
                //Mileage Label
                var txtWidth = context.measureText((diagramEndDFO-diagramBeginDFO).toFixed(3) + " mi.").width;
                drawText((diagramEndDFO-diagramBeginDFO).toFixed(3) + " mi.",canvas.width-(txtWidth*.6),22,"#FFFFFF","18");                
                 
                //DFO Label
                drawTextCenter("DFO",labelPositions[0],labelY-15,"#000000","10");
                
                //Add Datestamp
                const currentDate = new Date();
                
                // Get the individual components of the date
                const month = String(currentDate.getMonth() + 1);
                const day = String(currentDate.getDate());
                const year = String(currentDate.getFullYear());
                
                // Create the date stamp string
                const dateStamp = `${month}/${day}/${year}`;                
                drawText(dateStamp,canvas.width-35,canvas.height-10,"#000000","12");
                drawText("Source: TxDOT Roadway Inventory, TPP-Data Management",170,canvas.height-10,"#000000","12");
                
                //Draw the upper labels and tick marks
                for (let i = 0; i < labelPositions.length; i++) {
                  const labelX = labelPositions[i];
                  //Draw DFO Labels
                  drawTextCenter(roundToDecimalPlace(labelValue,3),labelX,labelY,"#000000",12);
            
                  //Draw tick marks end caps
                  if (i==0||i==labelPositions.length-1) {
                    drawLine(labelX,rulerY-20,labelX,rulerY+40,1,"#000000");
                  } else {
                    //Intermediate DFO
                    drawLine(labelX,rulerY-20,labelX,rulerY,1,"#000000");
                    //Intermediate MPT
                    drawLine(labelX,rulerY+20,labelX,rulerY+40,1,"#FF0000");
                  }
                  
                  labelValue += labelFactor;
                }                
                
                //Draw Multiple Control Sections found
                drawTextCenter("Verifying Control Sections...",labelPositions[2],labelY+115,"#FF0000","12");                
                
                var urlFromDFO = "https://lrs-ext.us-e1.cloudhub.io/api/elrs4?RouteID="+diagramTitle+"&DistanceFromOrigin="+diagramBeginDFO;
                var urlToDFO = "https://lrs-ext.us-e1.cloudhub.io/api/elrs4?RouteID="+diagramTitle+"&DistanceFromOrigin="+diagramEndDFO;
                
                var diagramBMP = "";
                var diagramEMP = "";
                
                try{
                  let respUrlFromDfo = await request(urlFromDFO)
                  //Getting begin CS and BMP
                  diagramCSBegin = [respUrlFromDfo.data[0].CTRL_SECT_LN_NBR, respUrlFromDfo.data[0].CTRL_SECT_MPT];

                  let respUrlToDFO = await request(urlToDFO)
                  diagramCSEnd = [respUrlToDFO.data[0].CTRL_SECT_LN_NBR,respUrlToDFO.data[0].CTRL_SECT_MPT];
                  //If the Begin and End CS match, call the CS portion of the diagram
                    if(diagramCSBegin[0]===diagramCSEnd[0]) {
                      drawMPTLabels = true;
                      processControlSectionRuler(diagramCSBegin[0],diagramCSBegin[1]);
                    } else {
                      //Add the inventory attributes but don't label milepoints
                      drawMPTLabels = false;
                      drawRectangle(labelPositions[2]-125,labelY+105,250,20,"#FFFFFF");
                      drawTextCenter("Multiple Control Sections",labelPositions[2],labelY+115,"#FF0000","12")
                      //Draw white box to clear loading message
                      //Draw Multiple Control Sections found
                      if (inventoryDiagramLogAllValues.length>0) {
                        //Add inventory attributes from the URL
                        for (var i = 0; i < inventoryDiagramLogAllValues.length; i++) { 
                          addInventoryAttribute(inventoryDiagramLogAllValues[i]);
                        }
                      }
                    }
                    document.querySelectorAll(`.srdBtn`).forEach(x => x.disabled = false)
                    document.getElementById("riAttributes").disabled = false
                    document.getElementById("btnToggleDiagramView").textContent = "Hide Diagram"
                    document.getElementById("btnUpdateLRM").textContent = "Create Diagram" 
                    document.getElementById("btnExportPNG").disabled = false
                    document.getElementById("btnExportJPEG").disabled = false
                    document.getElementById("btnDiagramGenerateURL").disabled = false
                }
                catch(err){
                  drawRectangle(labelPositions[2]-125,labelY+105,250,20,"#FFFFFF");
                  drawTextCenter("Unable to draw Control Sections...",labelPositions[2],labelY+115,"#FF0000","12");
                  document.getElementById("riAttributes").disabled = true
                  document.getElementById("btnUpdateLRM").textContent = "Create Diagram"
                  document.getElementById("btnUpdateLRM").disabled = false
                  document.getElementById("btnClearDiagramView").disabled = false
                }
                
                //Getting end CS and EMP  
              }
              //End check diagram fields----------------------------------------
              
              function processControlSectionRuler(theCSNBR,theCSBMP) {
                csNBR = theCSNBR;
                beginMPT = theCSBMP;
                var csLabelValue = beginMPT;
                
                //Draw the lower labels and tick marks
                for (let i = 0; i < labelPositions.length; i++) {
                  const labelX = labelPositions[i];
                  //Draw MPT Labels
                  drawTextCenter(roundToDecimalPlace(csLabelValue,3),labelX,labelY+90,"#FF0000",12)                  
                  csLabelValue += labelFactor;
                }                 
                
                //Adding a dash
                csNBR = csNBR.substring(0, 4) + "-" + csNBR.substring(4);
                //Draw white box to clear loading message
                drawRectangle(labelPositions[2]-125,labelY+105,250,20,"#FFFFFF");                
                //Draw Control Section Text
                drawTextCenter("Control Section: "+csNBR,labelPositions[2],labelY+115,"#FF0000","14");  
                //Milepoint Label
                drawTextCenter("Milepoint",labelPositions[0],labelY+105,"#FF0000","10");
                
                if (inventoryDiagramLogAllValues.length>0) {
                  //Add inventory attributes from the URL
                  for (var i = 0; i < inventoryDiagramLogAllValues.length; i++) {
                    addInventoryAttribute(inventoryDiagramLogAllValues[i]);
                  }
                }
              }              
              
              function addInventoryAttribute(inventoryAttribute) {
                if (numberOfAttributes>maxAttributesOnPage) {
                  alert("Maximum number of attributes reached.");
                  return;
                }
          
                inventoryDiagramLog.push(inventoryAttribute[2]);
                var inventoryService = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/" + inventoryAttribute[0] + "/FeatureServer/0";
                
                if (inventoryAttribute[2]=="Reference Markers") {
                  var theFields = "RTE_NM,DFO," + inventoryAttribute[1];                 
                  var theQuery = "RTE_NM='" + diagramTitle + "'" + " AND (DFO < " + diagramEndDFO + " AND DFO > " + diagramBeginDFO + ")";
                  var theOrder = "RTE_NM ASC, DFO ASC";  
                  var theRequestURL = inventoryService + "/query?f=json&orderByFields=" + theOrder + "&returnGeometry=false&where=" + theQuery + "&outFields=" + theFields;                    
                  
                  //Request for Points
                  request(theRequestURL)
                    .then(function(response) {
                      processInventoryAttributePoint(response,inventoryAttribute[2]);
                    })
                    .catch((err)=>{
                    })       
                } else {
                  var theFields = "RTE_NM,BEGIN_DFO,END_DFO," + inventoryAttribute[1];                 
                  var theQuery = "RTE_NM='" + diagramTitle + "'" + " AND (BEGIN_DFO < " + diagramEndDFO + " AND END_DFO > " + diagramBeginDFO + ")";
                  var theOrder = "RTE_NM ASC, BEGIN_DFO ASC"; 
                  var theRequestURL = inventoryService + "/query?f=json&orderByFields=" + theOrder + "&returnGeometry=false&where=" + theQuery + "&outFields=" + theFields;                    
                  if(!inventoryAttribute[2]){return}
                  //Loading status message that get effectively erased
                  drawTextCenter("Loading " + inventoryAttribute[2],labelPositions[2],attributeStartY+(numberOfAttributes*spacePerAttribute)+15,"#000000","10");                  
                  
                  //Request for Lines
                  request(theRequestURL)
                    .then(function(response) {
                      processInventoryAttribute(response,inventoryAttribute[2]);
                    })
                    .catch((err)=>{
                      console.log(err)
                    })                
                }
              }
              
              function processInventoryAttributePoint(response,theInventoryLabel) {
                var returnedFeatures = response.data.features;
                var attBeginDFO;
                var attValueGroup;
                var attValue=45;
                var dfoValue;
                var mptValue;
                if(!returnedFeatures.length){
                  let beginPix = rulerMargin+(pixelsPerMile*(0-diagramBeginDFO))
                  let widths = (pixelsPerMile*(0-diagramBeginDFO))
                  drawRectangle(35,attributeStartY+(numberOfAttributes*spacePerAttribute),rulerWidth,16,"#FFFFFF"); 
                  drawRectangle(35,attributeStartY+(numberOfAttributes*spacePerAttribute),rulerWidth,2,"#D3D3D3");
                  drawRectangle((Math.round(rulerWidth/2))-9,attributeStartY+(numberOfAttributes*spacePerAttribute)-8,90,16,"#696969");  
                  drawTextCenter("No Records",35+(Math.round(rulerWidth/2)),attributeStartY+(numberOfAttributes*spacePerAttribute)+5,"#FFFFFF",13)
                  drawText(theInventoryLabel,95,attributeStartY+(numberOfAttributes*spacePerAttribute)-15,"#000000","10");
                  numberOfAttributes+=1;
                  return
                }
                for (var i = 0; i < returnedFeatures.length; i++) {
                  attBeginDFO = returnedFeatures[i].attributes.DFO;
                  attValueGroup = returnedFeatures[i].attributes;
                  
                  const jsonArray = Object.entries(attValueGroup); 
                  
                  for (let j = 0; j < jsonArray.length; j++) {
                    const [key, value] = jsonArray[j];
                    if (key=="RTE_NM"||key=="DFO") {
                      //nothing
                    } else {
                      attValue = value;
                    }
                  }
                  
                  var eventBeginPixelValue = rulerMargin+(pixelsPerMile*(attBeginDFO-diagramBeginDFO));
                  //Draw background rectangle for Marker Number
                  drawRectangle(eventBeginPixelValue-6,attributeStartY-127,12,34,"#008000");
                  attValue = attValue.toString();
                  
                  //Draw stacked text
                  var markerTextStartY = attributeStartY-116;
                  
                  //Offsetting based on marker character length
                  if (attValue.length==1) {
                    markerTextStartY+=10
                  }
                  if (attValue.length==2) {
                    markerTextStartY+=5
                  }
                  
                  for (let j = 0; j < attValue.length; j++) {
                    const character = attValue.charAt(j);
                    drawText(character,eventBeginPixelValue,markerTextStartY,"#FFFFFF",12);
                    markerTextStartY += 10;
                  }                    
                }
              }              
            
              function processInventoryAttribute(response,theInventoryLabel) {
                var returnedFeatures = response.data.features;
                var attBeginDFO;
                var attEndDFO;
                var attValueGroup;
                var attValue;
                var dfoValue;
                var mptValue;
                if(!returnedFeatures.length){
                  let beginPix = rulerMargin+(pixelsPerMile*(0-diagramBeginDFO))
                  let widths = (pixelsPerMile*(0-diagramBeginDFO))
                  drawRectangle(35,attributeStartY+(numberOfAttributes*spacePerAttribute),rulerWidth,17,"#FFFFFF"); 
                  drawRectangle(35,attributeStartY+(numberOfAttributes*spacePerAttribute),rulerWidth,2,"#D3D3D3");
                  drawRectangle((Math.round(rulerWidth/2))-9,attributeStartY+(numberOfAttributes*spacePerAttribute)-8,90,16,"#696969");  
                  drawTextCenter("No Records",35+(Math.round(rulerWidth/2)),attributeStartY+(numberOfAttributes*spacePerAttribute)+5,"#FFFFFF",13)
                  drawText(theInventoryLabel,95,attributeStartY+(numberOfAttributes*spacePerAttribute)-15,"#000000","10");
                  numberOfAttributes+=1;
                  return
                }

                for (var i = 0; i < returnedFeatures.length; i++) {
                  attBeginDFO = returnedFeatures[i].attributes.BEGIN_DFO;
                  attEndDFO = returnedFeatures[i].attributes.END_DFO;
                  attValueGroup = returnedFeatures[i].attributes;
                  
                  const jsonArray = Object.entries(attValueGroup); 
                  
                  for (let j = 0; j < jsonArray.length; j++) {
                    const [key, value] = jsonArray[j];
                    if (key=="RTE_NM"||key=="BEGIN_DFO"||key=="END_DFO") {
                      //nothing
                    } else {
                      attValue = value;
                    }
                  }
                  
                  //Clip to graphic DFO range
                  if (attBeginDFO<diagramBeginDFO) {
                    attBeginDFO=diagramBeginDFO;
                  }
                  if (attEndDFO>diagramEndDFO) {
                    attEndDFO=diagramEndDFO;
                  }                
                  
                  //Selecting alternating colors
                  const [darkColor, lightColor] = diagramColors[numberOfAttributes];
                  const selectedColor = i % 2 === 0 ? lightColor : darkColor;                  
                  var eventBeginPixelValue = rulerMargin+(pixelsPerMile*(attBeginDFO-diagramBeginDFO));
                  var eventEndPixelValue = (pixelsPerMile*(attEndDFO-attBeginDFO));
                  
                  //Draw event
                  drawRectangle(eventBeginPixelValue,attributeStartY+(numberOfAttributes*spacePerAttribute),eventEndPixelValue,20,selectedColor);
                  
                  //If length of event is greater than label for event then draw the label
                  var canvas = document.getElementById("myCanvas");
                  var context = canvas.getContext("2d");
                  var txtWidth = context.measureText(attValue).width+10;

                  if (txtWidth<eventEndPixelValue) {
                    //Draw label for event
                    drawTextCenter(attValue,eventBeginPixelValue+(Math.round(eventEndPixelValue/2)),attributeStartY+(numberOfAttributes*spacePerAttribute)+15,"#FFFFFF",13);                  
                  }
                  
                  if (i>0) {
                    //Draw vertical dividing events
                    drawLine(eventBeginPixelValue,attributeStartY+(numberOfAttributes*spacePerAttribute),eventBeginPixelValue,attributeStartY+(numberOfAttributes*spacePerAttribute)+20,1,"#000000");                    
                    
                    //Not drawing labels if event is too small
                    if (txtWidth<eventEndPixelValue) {
                      //Draw DFO label
                      dfoValue = roundToDecimalPlace(((eventBeginPixelValue-rulerMargin)/pixelsPerMile)+diagramBeginDFO,3);
                      drawTextCenter(dfoValue,eventBeginPixelValue,attributeStartY+(numberOfAttributes*spacePerAttribute)-3,"#000000",11); 
                      
                      //Draw MPT label
                      if (drawMPTLabels==true) {
                        mptValue = roundToDecimalPlace(((eventBeginPixelValue-rulerMargin)/pixelsPerMile)+beginMPT,3);;
                        drawTextCenter(mptValue,eventBeginPixelValue,attributeStartY+(numberOfAttributes*spacePerAttribute)+31,"#FF0000",11);                        
                      }
                    }
                  }
                }
                drawText(theInventoryLabel,95,attributeStartY+(numberOfAttributes*spacePerAttribute)-15,"#000000","10");
                numberOfAttributes+=1;
              }

              //Drawing functions-----------------------------------------------
              function drawCircle(begX,begY,theRadius,theColor) {
                  var canvas = document.getElementById("myCanvas");
                  var ctx = canvas.getContext("2d");
                  ctx.beginPath();
                  ctx.fillStyle = theColor;
                  ctx.arc(begX,begY,theRadius,0,2*Math.PI);
                  ctx.fill();
                  // ctx.stroke();
              }              
              
              function drawRectangle(begX,begY,theWidth,theHeight,theColor) {
                  var canvas = document.getElementById("myCanvas");
                  var ctx = canvas.getContext("2d");
                  ctx.fillStyle = theColor;
                  ctx.fillRect(begX,begY,theWidth,theHeight);
                  //   ctx.stroke();
              }       
              
              function drawPolygon(theCoords,theWidth,fillColor,outlineColor,theScale) {
                  var canvas = document.getElementById("myCanvas");
                  var ctx = canvas.getContext("2d");
                  ctx.scale(theScale, theScale);
                  ctx.beginPath();
                  ctx.lineWidth = theWidth;
              
                  //First point
                  ctx.moveTo(theCoords[0][0],theCoords[0][1]);
              
                  //Remainder of points
                  for (var i = 0; i < theCoords.length; i++) {
                      if (i > 0) {
                          ctx.lineTo(theCoords[i][0],theCoords[i][1]);
                      }
                  }
              
                  //Closing the polygon
                  ctx.closePath();
              
                  //Colors and styles
                  ctx.fillStyle = fillColor;
                  ctx.fill();
                  ctx.strokeStyle = outlineColor;
                  ctx.stroke();
              }      
              
              function drawPoint(begX,begY,theRadius,theColor) {
                  var canvas = document.getElementById("myCanvas");
                  var ctx = canvas.getContext("2d");
                  ctx.beginPath();
                  ctx.fillStyle = theColor;
                  ctx.arc(begX,begY,theRadius,0,2*Math.PI);
                  ctx.fill();
              }
              
              function drawLine(begX,begY,endX,endY,theWidth,theColor) {
                  var canvas = document.getElementById("myCanvas");
                  var ctx = canvas.getContext("2d");
                  ctx.beginPath();
                  ctx.lineWidth = theWidth;
                  ctx.moveTo(begX,begY);
                  ctx.lineTo(endX,endY);
                  ctx.strokeStyle = theColor;
                  ctx.stroke();
              }              
              
              function clearDrawings() {
                  var canvas = document.getElementById("myCanvas");
                  var ctx = canvas.getContext("2d");
                  ctx.setTransform(1, 0, 0, 1, 0, 0);
                  ctx.clearRect(0, 0, canvas.width, canvas.height);
              }      
              
              function drawText(theText,theX,theY,theColor,theSize) {
                  var canvas = document.getElementById("myCanvas");
                  var ctx = canvas.getContext("2d");
                  ctx.font = theSize + "px sans-serif";
                  ctx.fillStyle = theColor;
                  ctx.fillText(theText,theX,theY);
              }   
              
              function drawTextCenter(theText,theX,theY,theColor,theSize) {
                  var canvas = document.getElementById("myCanvas");
                  var ctx = canvas.getContext("2d");
                  ctx.font = theSize + "px sans-serif";
                  ctx.fillStyle = theColor;
                  ctx.textAlign = "center";
                  ctx.fillText(theText,theX,theY);
              }               
              //End drawing functions-------------------------------------------
              
              //Numberic Operations---------------------------------------------
              function roundToDecimalPlace(value,decimals) {
                  return Number(Math.round(value+'e'+decimals)+'e-'+decimals);
              }
              
              //Graphic Export Options------------------------------------------
              function exportJPEG() {
                  var exportCanvas = document.getElementById("myCanvas");
                  var dataURL = exportCanvas.toDataURL();
              
                  if (window.navigator.msSaveBlob) {
                      window.navigator.msSaveBlob(exportCanvas.msToBlob(), "exportImage.jpeg");
                  }
                  else {
                      const a = document.createElement("a");
                      document.body.appendChild(a);
                      a.href = exportCanvas.toDataURL('image/jpeg', 1.0);
                      a.download = "exportImage.jpeg";
                      a.click();
                      document.body.removeChild(a);
                  }
              }        
              
              function exportPNG() {
                  var exportCanvas = document.getElementById("myCanvas");
                  var dataURL = exportCanvas.toDataURL();
                  
                  if (window.navigator.msSaveBlob) {
                      window.navigator.msSaveBlob(exportCanvas.msToBlob(), "exportImage.png");
                  }
                  else {
                      const a = document.createElement("a");
                      document.body.appendChild(a);
                      a.href = exportCanvas.toDataURL();
                      a.download = "exportImage.png";
                      a.click();
                      document.body.removeChild(a);
                  }
              }       
              //End Export Options----------------------------------------------

              //Show or Hide Div------------------------------------------------
              function toggleVisibility(theElement) {
                var div = document.getElementById(theElement);
                if (div.style.display === "none") {
                  div.style.display = "block";
                } else {
                  div.style.display = "none";
                }
              }
              //----------------------------------------------------------------

              function resetShareUrl(){

                document.getElementById("previewUrl").textContent = ""
              }
              //Download controls
              function openModal() {
          			document.getElementById("modal").style.display = "block";
          		}
          
          		function closeModal() {
          			document.getElementById("modal").style.display = "none";
          		}
          		
          		function zoomToGraphicExtent() {
                var graphicsExtent = graphicsLayer.graphics.reduce(function(extent, graphic) {
                  return extent ? extent.union(graphic.geometry.extent) : graphic.geometry.extent;
                }, null);
                
                view.goTo(graphicsExtent);                
          		}

              function queryToUrl(textString, btnCoords){
                  navigator.clipboard.writeText(textString)
                  .then(()=>{
                    queryResponseUI({para: "URL has been copied! Paste and go.", url: textString, header:"Share URL"}, btnCoords, height="250px", width="350px")
                    document.getElementById("previewUrl").textContent = textString
                  })
                  .catch(err => console.log("exportQuery:", err))
  
                return
              }
          
              //Export Query to URL---------------------------------------------
              function exportQueryToURL() {
                let isVisibleLayers = returnVisibleLayers()
                var outputFieldsSelect = document.getElementById("outputFields");
                let queryType = getCurrentQuerySelection()
                var outputFieldList = Array.from(outputFieldsSelect.selectedOptions).map(option => option.value).join(',');
                var queryWhere = conditions.map(condition => `${condition.field}${condition.operator}${condition.value}`).join(' AND ');                
                let arrayString = isVisibleLayers.length ? `?overlays=${isVisibleLayers.toString()}&queryType=${queryType}&tab=query&query=${outputFieldList}|${queryWhere}` : `?queryType=${queryType}&tab=query&query=${outputFieldList}|${queryWhere}`
               
                var fullString = `${window.location.origin}${window.location.pathname}${arrayString}`;

                queryToUrl(fullString)
                return
              }
              //----------------------------------------------------------------
              
              //Export Diagram to URL-------------------------------------------
              function exportDiagramToURL () {
                let isVisibleLayers = returnVisibleLayers()
                var diagramAttributes = inventoryDiagramLog.join(',');
                var arrayString = isVisibleLayers.length ? `?overlays=${isVisibleLayers.toString()}&tab=diagram&diagram=` + diagramTitle + "," + diagramBeginDFO + "," + diagramEndDFO : "?tab=diagram&diagram=" + diagramTitle + "," + diagramBeginDFO + "," + diagramEndDFO;
                let fullString = `${window.location.origin}${window.location.pathname}${arrayString}|${diagramAttributes}`
                
                queryToUrl(fullString)
                return
              }
              //----------------------------------------------------------------
              
              //Export Graphics to URL------------------------------------------
              function exportGraphicsToURL() {
                let isVisibleLayers = returnVisibleLayers()
                var outputArray = [];
                var graphics = graphicsLayer.graphics.items;
                if (graphics.length > 0) {
                  for (var i = 0; i< graphics.length; i++) {
                    outputArray.push(graphics[i].attributes);
                  }
                }                
                
                var arrayString = outputArray.map(function(innerArray) {
                  return innerArray.join(",");
                }).join("|");    
                
                arrayString = isVisibleLayers.length ? `?overlays=${isVisibleLayers.toString()}&tab=event&event=` + arrayString : "?tab=event&event=" + arrayString;
                var replacedString = arrayString.replace(/#/g, "%23");
                
                replacedString = `${window.location.origin}${window.location.pathname}${replacedString}`
                
                queryToUrl(replacedString)
              }  
              //End Export Graphics---------------------------------------------              
              
              function resetLRSIdentify() {
                graphicsLayerLRSIdentify.removeAll();
                resetAllTools();
                clearInnerHTML("mapClickResults");
                lrsButtonStatus=false;  
                document.getElementById("viewDiv").style.cursor = "default"              
              }

              //load Table of Contents items
              async function loadTOCContent(){
                const docFrag = document.createDocumentFragment()
                let returnToc = await tocFeatureLayer.queryFeatures({
                  where: "1=1",
                  orderByFields: ["name"],
                  outFields: ["*"]
                })
                returnToc.features.forEach((x)=>{
                  let splitUrl = !x.attributes.url ? null : x.attributes.url.split(",")
                  itemArr.push({name: x.attributes.name, url: splitUrl, tocType: x.attributes.Toc_Type, popup: x.attributes.popup, popupTxt: x.attributes.popupText, defExpress: x.attributes.defExpress, render: x.attributes.renderer, isLabel: x.attributes.labelText, visible: false, addToTOC: 0})
                })
                createTOC(itemArr, docFrag)  
                await addBasemapAndFeatureToMap(itemArr)
                searchOverlays(docFrag)
              }

              function createTOC(tocObj, documentFrag){
                const tocTable = document.getElementById("tocMaps")
                tocTable.innerHTML += `
                  <tr><td id="CLEAR" style="border-left:6px solid #14375A; padding-left: .6rem; background-color:rgba(20,55,90,.2)">Clear Overlays</td></tr>
                  <tbody id="featRow"> 
                  </tbody>
                  <tr><th class="basemapHeader">Additional Overlays</th></tr>
                  <small style="position:relative; left: .3rem;">Select a Layer to Add (Max 5):</small>
                  <div class="dropDown">
                  <select name="dropDown" id="layerSearch" placeholder="Search for Layer"></select>
                  </div>
                  <tbody id="addFeatRow"> 
                  </tbody>
                `
                const setAlert = JSON.parse(tocObj.find((x) => x.name === "SPM ALERT").popup)
                setAlert.IsActive === "Yes" ? createServiceDown(setAlert.Text, setAlert.Color) : null

                let previousItem
                for(i=0; i < tocObj.length; i++){
                  if(tocObj[i].name === previousItem) continue
                  previousItem = tocObj[i].name
                  if(mainTOCLayers.includes(tocObj[i].name)){
                    appendChildToOverlayList(tocObj[i].name, tocObj[i].tocType, true, documentFrag)
                    continue
                  }
                  if(tocObj[i].name === "RoadInventory" || tocObj[i].name === "Texas Roadways Unsegmented" || tocObj[i].tocType != "FeatureLayer") continue
                  buildDropDown(tocObj[i].name)
                }

                document.getElementById("featRow").appendChild(documentFrag)

              } 

              function buildDropDown(name){
                let dropdown = document.getElementById("layerSearch")
                let option = document.createElement("option")
                option.value = name
                option.appendChild(document.createTextNode(name))
                dropdown.appendChild(option)
              }

              function checkAdditionalOverlayCount(element){
                let num = itemArr.filter(y => y.addToTOC === 1)
                if(num.length === 5){
                  document.getElementById("layerSearch").disabled = true
                  return
                }
                document.getElementById("layerSearch").disabled = false
                return
              }

              function appendChildToOverlayList(layerItem, layerType, initBuild, documentFrag){
                  let noDownload = ["Live Traffic" , "Shale Plays", "Future Interstates"]
                  let tr = document.createElement("tr")
                  let td = document.createElement("td")
                  td.id = layerItem
                  td.className = "baseMapList"
                  td.onclick = (event) => {
                    if(event.target.id.includes("dwnloadBtn")){return}
                    document.getElementById(`dwnloadBtn${layerItem}`).style.display = document.getElementById(`dwnloadBtn${layerItem}`).style.display === "block" ? "none" : "block"
                    return
                  }
                  let div = document.createElement("div")
                  div.id = layerItem
                  let dwnloadBtn = document.createElement("button")
                  dwnloadBtn.style.display = "none"
                  dwnloadBtn.id = `dwnloadBtn${layerItem}`
                  dwnloadBtn.title = noDownload.includes(layerItem) ? "No Download" : "Download Overlay"
                  dwnloadBtn.className = noDownload.includes(layerItem) ? "esri-icon-download noDwnloadBtn" : "esri-icon-download dwnloadBtn"
                  
                  noDownload.includes(layerItem) ? dwnloadBtn.disabled = true : null
                  dwnloadBtn.onclick = () => downloadOverlay(layerItem)
                  if(initBuild === false){
                    let btnDiv = document.createElement("div")
                    btnDiv.id = "rmvDiv"
                    let rmvButton = document.createElement("button")
                    btnDiv.appendChild(rmvButton)
                    rmvButton.className = "esri-icon-close-circled removeOverlay"
                    rmvButton.id = `removeOverlay${layerItem}`
                    rmvButton.onclick = () => toggleLayer(layerItem)
                    td.appendChild(btnDiv)
                  }

                  td.appendChild(dwnloadBtn)
                  div.appendChild(document.createTextNode(layerItem))
                  div.style.width = "80%"
                  td.appendChild(div)

                  tr.appendChild(td)
                  if(layerType === "FeatureLayer"){
                    initBuild === false ? document.getElementById("addFeatRow").appendChild(tr) : documentFrag.appendChild(tr)
                    return
                  }
              }

              function removeOverlay(id){
                if(!id) return
                let [idLeft, idRight] = id.split("removeOverlay")
                if(!idRight){return}
                let url = itemArr.find(name => name.name === idRight)
                let returnfeatLayer = retrieveFeatureLayer(url.name)
                returnfeatLayer.forEach(x => {
                  x.visible = false
                  itemArr.find(y => y.name === x.name).visible = 0
                })
                document.getElementById("addFeatRow").childNodes.forEach((i,x) => {
                  if(i.textContent.includes(idRight)){
                    i.remove()
                  }
                })
                itemArr.find(z => z.name === idRight).addToTOC = 0
                checkAdditionalOverlayCount()
                return
              }

              function addFeatureLayerToMap(featLayer, popupInfo){
                  let label = JSON.parse(featLayer.isLabel)
                  let featLayerLabel = new LabelClass(label)

                  let addFeatureLayer = new FeatureLayer({
                    url: featLayer.url,
                    visible: false,
                    outFields: ["*"],
                    name: featLayer.name,
                    popupEnabled: true,
                    popupTemplate: popupInfo,
                    labelIsVisible: true,
                    labelingInfo: JSON.parse(featLayer.isLabel) ?  [featLayerLabel] : "",
                    dockOptions:{
                      position: "bottom-right"
                    },
                    definitionExpression: featLayer.defExpress ?? "", 
                  })
                  
                  featLayer.render ? addFeatureLayer.renderer = JSON.parse(featLayer.render) : null
                  addFeatureLayer.when((layer)=>{               
                    layer.opacity = layer.geometryType === "polygon" ? 0.3 : 1
                    if(layer.title === "TxDOT Bridges" || layer.title === "TxDOT Roadway Inventory"){
                      if(layer.title === "TxDOT Bridges"){
                        bridgeInventoryFieldsArray = layer.fieldsIndex.uid.split(",")
                        createSourcesArr(layer)
                        return 
                      }
                        featureLayerView = layer.fieldsIndex.uid.split(",")
                        return
                    }

                    if(addFeatureLayer.name === "Texas Roadways Unsegmented"){
                      basemapFeatureLayerActiveCheck(`${addFeatureLayer.parsedUrl.path}`, "featureLayer")
                      addFeatureLayer.visible = true
                      addFeatureLayer.opacity = 0
                      addFeatureLayer.legendEnabled = false
                      addFeatureLayer.definitionExpression = `RTE_PRFX in ('IH') AND RDBD_TYPE = 'Single Roadbed'`
                      return
                    }
                    createSourcesArr(layer)
                   
                  })
                  map.add(addFeatureLayer)
                return
              }

              async function addBasemapAndFeatureToMap(featLayerUrlArr){
                let addToMapPromise = new Promise(async(res, rej) =>{
                  for(i=0; i < featLayerUrlArr.length; i++){
                  //add Feature Layer Info
                    if(!featLayerUrlArr[i].url) continue //remove once Inrix set up
                    if(featLayerUrlArr[i].tocType === "FeatureLayer" || featLayerUrlArr[i].tocType === "Search"){
                      let popupObj = JSON.parse(featLayerUrlArr[i].popup)
                      let popupObjText = JSON.parse(featLayerUrlArr[i].popupTxt)
                      let popupInfo = await createpopupTemplate(featLayerUrlArr[i].name, popupObj, popupObjText)
                      addFeatureLayerToMap(featLayerUrlArr[i], popupInfo)
                      continue
                    }
                    
                  }
                  res("complete")
                  rej("error")
                })

                let returnToken = await getInrixToken()
                let inrixUrl = `http://tile-api.inrix.com/v1/tiles/{level}{col}{row}?roadsegmenttype=XDS&opacity=60&FRCLevel=1,2,3&penWidth=4&accessToken=${returnToken}`

                let webLayer = new WebTileLayer({
                  urlTemplate: inrixUrl,
                  subDomains: ["a", "b", "c"],
                  copyright: "TxDOT, INRIX",
                  visible: false,
                  name: "Live Traffic"
                })
                
                webLayer.getTileUrl = (level, col, row) =>{
                  var quadKeys = retrieveQuadKey(level, col, row);
                  var penWidth = 9;
								  var frcLevel = "1,2,3";

                  //Adjust line width and data density by zoom level
                  if (level <= 8) {
                    penWidth = 9;
                    frcLevel = "1";
                  } else if (level > 8 && level <= 10) {
                    penWidth = 9;
                    frcLevel = "1,2";
                  } else if (level > 10 && level <= 12) {
                    penWidth = 9;
                    frcLevel = "1,2,3";
                  } else if (level > 12 && level <= 14) {
                    penWidth = 10;
                    frcLevel = "1,2,3,4";
                  } else {
                    penWidth = 11;
                    frcLevel = "1,2,3,4,5,6,7";
                  }

                  let returnUrl = `https://tile-api.inrix.com/v1/tiles/${quadKeys}?accessToken=${returnToken}&penWidth=${penWidth}&opacity=60&frcLevel=${frcLevel}&roadsegmenttype=XDS`
                   
                  return returnUrl
                }

                map.add(webLayer)
                
                return await addToMapPromise
              }

              function createSourcesArr(featLayer){
                let sourcesObj = [{url: "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Projects/FeatureServer/0", name: "TxDOT_Projects", searchFields: ["CONTROL_SECT_JOB"], displayField: "CONTROL_SECT_JOB", outFields: ["CONTROL_SECT_JOB","DISTRICT_NUMBER","HIGHWAY_NUMBER"], title: "Control Section Job (CSJ)"},
                                {url:"https://services.arcgis.com/KTcxiTD9dsQw4r7Z/ArcGIS/rest/services/Texas_County_Boundaries_Detailed/FeatureServer/0", name: "Texas_County_Boundaries_Detailed", searchFields: ["CNTY_NM"], displayField: "CNTY_NM", outFields: ["*"], title: "County"},
                                {url:"https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Districts/FeatureServer/0", name: "TxDOT_Districts/FeatureServer", searchFields: ["DIST_NM"], displayField: "DIST_NM", outFields: ["*"], title:"District"},
                                {url:"https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Roadways_Search/FeatureServer/0", name: "TxDOT_Roadways_Search/FeatureServer", searchFields: ["RTE_CNTY"], displayField: "RTE_CNTY", outFields: ["*"], title: "On System Highway"},
                                {url:"https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Top_100_Congested_Roadways/FeatureServer/0", name: "TxDOT_Top_100_Congested_Roadways/FeatureServer", searchFields: ["RANK"], displayField: "RANK", outFields: ["*"], title: "Top 100 Rank"},
                                {url:"https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Highway_Designations/FeatureServer/0", name: "TxDOT_Highway_Designations/FeatureServer", searchFields: ["MO_NBR"], displayField: "MO_NBR", outFields: ["*"], title: "Minute Order Number"},
                                {url:"https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Bridges/FeatureServer/0", name: "TxDOT_Bridges/FeatureServer/0", searchFields: ["BRDG_ID"], displayField: "BRDG_ID", displayField: "BRDG_ID", outFields:["*"], title: "NBI Structure Number (Bridge ID)"},
                                {url:"https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_City_Boundaries/FeatureServer/0", name: "TxDOT_City_Boundaries", searchFields: ["CITY_NM"], displayField: "CITY_NM", outFields: ["*"], title: "City"},
                                {url:"https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Control_Sections/FeatureServer/0", name: "TxDOT_Control_Sections", searchFields: ["CTRL_SECT_NBR"], displayField: "CTRL_SECT_NBR", outFields: ["*"], title:"Control Section"}]

                let featLayerPath = featLayer.parsedUrl.path.toLowerCase()
                let src = sourcesObj.find(source => featLayerPath.includes(source.url.toLowerCase()))
                let isInSearch = src ? searchBar.sources.find(x => x.name === src.title) : null          
                if(!src || isInSearch) return
                let sourceObj = {
                  layer: new FeatureLayer({
                        url: src.url,
                  }),
                  searchFields: src.searchFields,
                  suggestionsEnabled: true,
                  displayField: src.displayField,
                  exactMatch: false,
                  autoSelect: true,
                  maxResults: 6,
                  maxSuggestions: 6,
                  minSuggestCharacters: 0,
                  outFields: src.outFields,
                  name: src.title,
                  resultSymbol: {
                      type: "simple-line",
                      color: "cyan",
                      width: "6px",
                  }
                }
                searchBar.sources.push(sourceObj)
              }

              function searchOverlays(){
                document.getElementById("layerSearch").addEventListener("change", (event)=>{
                  let itemInArr = itemArr.find(x => x.name === event.target.value)
                  if(itemInArr.addToTOC === 1) {return}
                  itemInArr.addToTOC = 1
                  checkAdditionalOverlayCount()
                  appendChildToOverlayList(event.target.value, "FeatureLayer", false)
                  toggleLayer(event.target.value)
                  document.getElementById(`dwnloadBtn${itemInArr.name}`).style.display = "block"
                })
              }

              async function getInrixToken(){
                let urlRequest = `https://services.arcgis.com/KTcxiTD9dsQw4r7Z/ArcGIS/rest/services/inrix_token_view/FeatureServer/0/query?f=json&orderByFields=token ASC&returnGeometry=false&where=OBJECTID>=0&outFields=*`
                let request = await fetch(urlRequest)
                let returnedItem = await request.json() 
                return returnedItem.features[0].attributes.token
              }

              function retrieveQuadKey(zoom,y,x){
                let key = []

								for (let i = zoom; i > 0; i--){
                  let keyVal = 0;
                  let mask = 1 << (i - 1);
                  if ((x & mask) !== 0) {
                    keyVal++;
									}
                  if ((y & mask) !== 0) {
                    keyVal+=2;
                  }
									key.push(keyVal);
								}
                let quadKey = key.join("");
                return quadKey;
              } 
              
              async function createpopupTemplate(titleField, popupInfo, popupText){
                let template 
                  template = {
                    title: titleField,
                    content: [
                      {
                      type: "text",
                      text: popupText ? popupText.top : "",
                    },{
                      type: "fields",
                      fieldInfos: []
                    },{
                      type: "text",
                      text: popupText ? popupText.bottom : "",
                    }],

                    expressionInfos:[]
                  }

                  if(!popupInfo) return
                  let fieldName = Object.values(popupInfo)
                  let label = Object.keys(popupInfo)
                  let a;
                  fieldName.forEach((i,x) => {
                    if(Object.hasOwn(popupArcadeDefinition,i)){
                      a = {
                      name: `${titleField}Exp${x}`,
                      title: label[x],
                      expression: popupArcadeDefinition[i],
                      }
                    }
                    else{
                      a = {
                      name: `${titleField}Exp${x}`,
                      title: label[x],
                      expression: `
                        if(TypeOf($feature.${i}) == "String"){
                          if(Count($feature.${i}) < 1){
                            return "UNKNOWN"
                          }

                          else{
                            return $feature.${i}
                          }
                        }
                        if(TypeOf($feature.${i}) == "Number"){
                          return $feature.${i}
                        }
                        else{
                          return "UNKNOWN"
                        }
                      `,
                      }
                    }

                    template.expressionInfos.push(a)
                    template.content[1].fieldInfos.push({"fieldName": `expression/${titleField}Exp${x}`})
                  })
                return template
              }

              async function downloadOverlay(featLayer){
                let featList = retrieveFeatureLayer(featLayer)

                for(let i=0; i < featList.length; i++){
                  let returnFetch = await fetch(`https://opendata.arcgis.com/api/v3/datasets/${featList[i].sourceJSON.serviceItemId}_${featList[i].sourceJSON.id}`)
                  let resp = await returnFetch.json()
                  let noDownload = ['3e666ee848fa4a48b318168a9ea02f61_0', "2d6f4631cbc14aa78378eb5781c8cf71_0"]
                  if(!noDownload.includes(resp.data.attributes.id)){
                    let a = document.createElement("a")
                    a.href = `${resp.meta.request}/downloads/data?format=fgdb&spatialRefId=4326&where=1=1`
                    a.download = `${resp.meta.request}/downloads/data?format=fgdb&spatialRefId=4326&where=1=1`
                    a.target = "_blank"
                    a.click()

                    a.remove()
                  }
                }
              }

              function queryExtent(){

              }

              const getActiveLayers = (z) => itemArr.forEach((x) => {
                if(x.visible === 1 || x.name === "Texas Roadways Unsegmented"){
                  let feat = retrieveFeatureLayer(x.name)
                    view.whenLayerView(feat[0]).then((y) =>{
                      // y.queryExtent().then((res) =>{
                      //   console.log(res)
                      // })
                      displayFeatOnZoom(y,z)
                    })
                }
              })
              
              async function displayFeatOnZoom(layerView,zoom){            
                let displayFeatZoom = ["AADT", "Functional Classification & Urban Areas", "Reference Markers", "Control Sections", "Speed Limits", "Future Traffic & Percent Truck", "Cemeteries", "Texas Roadways Unsegmented", "Roadway Inventory - On-System Roadbeds"]
                if(displayFeatZoom.includes(layerView.layer.name)){
                  let getItem = {
                    "Roadway Inventory - On-System Roadbeds" : () => {
                      switch(zoom){
                        case 6: 
                          layerView.layer.definitionExpression = "SUBSTRING(RIA_RTE_ID,1,2)='IH'"
                          break;
                        case 7:
                          layerView.layer.definitionExpression = "SUBSTRING(RIA_RTE_ID,1,2)='IH'"
                          break;
                        case 8:
                          layerView.layer.definitionExpression = "SUBSTRING(RIA_RTE_ID,1,2)='IH'"
                          break;
                        case 9:
                          layerView.layer.definitionExpression = "(SUBSTRING(RIA_RTE_ID,1,2)='IH' or SUBSTRING(RIA_RTE_ID,1,2)='US')"
                          break;
                        case 10:
                          layerView.layer.definitionExpression = "(SUBSTRING(RIA_RTE_ID,1,2)='IH' or SUBSTRING(RIA_RTE_ID,1,2)='US')"
                          break;
                        case 11:
                          layerView.layer.definitionExpression = "(SUBSTRING(RIA_RTE_ID,1,2)='IH' or SUBSTRING(RIA_RTE_ID,1,2)='US')"
                          break;
                        case 12:
                          layerView.layer.definitionExpression = ''
                          break;
                        case 13:
                          layerView.layer.definitionExpression = ''
                          break;
                        default:
                          layerView.layer.definitionExpression = ''
                          break;
                      }
                    },
                    "Texas Roadways Unsegmented" : () => {
                      switch(zoom){
                        case 6: 
                          layerView.layer.definitionExpression = "RTE_PRFX = 'IH' AND RDBD_TYPE = 'Single Roadbed'"
                          break;
                        case 7:
                          layerView.layer.definitionExpression = "RTE_PRFX = 'IH' AND RDBD_TYPE = 'Single Roadbed'"
                          break;
                        case 8:
                          layerView.layer.definitionExpression = "RTE_PRFX IN ('IH', 'US') AND RDBD_TYPE = 'Single Roadbed'"
                          break;
                        case 9:
                          layerView.layer.definitionExpression = "RTE_PRFX IN ('IH', 'US', 'SH', 'SL', 'FM', 'RM') AND RDBD_TYPE = 'Single Roadbed'"
                          break;
                        case 10:
                          layerView.layer.definitionExpression = "RTE_PRFX NOT IN ('CS', 'PR') AND RDBD_TYPE = 'Single Roadbed'"
                          break;
                        case 11:
                          layerView.layer.definitionExpression = "RTE_PRFX NOT IN ('CS', 'PR') AND RDBD_TYPE = 'Single Roadbed'"
                          break;
                        case 12:
                          layerView.layer.definitionExpression = ''
                          break;
                        case 13:
                          layerView.layer.definitionExpression = ''
                          break;
                        default:
                          layerView.layer.definitionExpression = ''
                          break;
                      }
                    },
                    "AADT" : () => {
                      switch(zoom){
                        case 5:
                          layerView.layer.definitionExpression = `zLevel < (7)`
                          break;
                        case 6:
                          layerView.layer.definitionExpression = `zLevel < (${zoom} + 1)`
                          break;
                        case 7:
                          layerView.layer.definitionExpression = `zLevel < (${zoom} + 1)`
                          break;
                        case 8:
                          layerView.layer.definitionExpression = `zLevel < (${zoom} + 1)`
                          break;
                        case 9:
                          layerView.layer.definitionExpression = `zLevel < (${zoom} + 1)`
                          break;
                        case 10:
                          layerView.layer.definitionExpression = `zLevel < (${zoom} + 1)`
                          break;
                        case 11:
                          layerView.layer.definitionExpression = `zLevel < (${zoom} + 1)`
                          break;
                        case 12:
                          layerView.layer.definitionExpression = `zLevel < (${zoom} + 1)`
                          break;
                        case 13:
                          layerView.layer.definitionExpression = `zLevel < (${zoom} + 1)`
                          break;
                        default:
                          layerView.layer.definitionExpression = `zLevel <= 13`
                          break;
                        }
                    },
                    "Functional Classification & Urban Areas" : () => {
                        switch(zoom){
                          case 6:
                            layerView.layer.title === "TxDOT Functional Classification" ? layerView.layer.definitionExpression = "RTE_PRFX ='IH' AND RDBD_TYPE = 'KG'" : null
                            break;
                          case 7:
                            layerView.layer.title === "TxDOT Functional Classification" ? layerView.layer.definitionExpression = "RTE_PRFX ='IH' AND RDBD_TYPE = 'KG'" : null
                            break;
                          case 8:
                            layerView.layer.title === "TxDOT Functional Classification" ? layerView.layer.definitionExpression = "RTE_PRFX ='IH' AND RDBD_TYPE = 'KG'" : null
                            break;
                          case 9:
                            layerView.layer.title === "TxDOT Functional Classification" ? layerView.layer.definitionExpression ="(RTE_PRFX IN ('IH', 'US') OR F_SYSTEM IN (1,2,3)) AND RDBD_TYPE = 'KG'" : null
                            break;
                          case 10:
                            layerView.layer.title === "TxDOT Functional Classification" ? layerView.layer.definitionExpression ="(RTE_PRFX IN ('IH', 'US') OR F_SYSTEM IN (1,2,3)) AND RDBD_TYPE = 'KG'" : null
                            break;
                          case 11:
                            layerView.layer.title === "TxDOT Functional Classification" ? layerView.layer.definitionExpression = "RDBD_TYPE = 'KG'" : null
                            break;
                          case 12:
                            layerView.layer.title === "TxDOT Functional Classification" ? layerView.layer.definitionExpression = "RDBD_TYPE = 'KG'" : null
                            break;
                          case 13:
                            layerView.layer.title === "TxDOT Functional Classification" ? layerView.layer.definitionExpression = "" : null
                            break;
                          default:
                            layerView.layer.title === "TxDOT Functional Classification" ? layerView.layer.definitionExpression = "" : null
                            break;
                        }
                    },
                    "Reference Markers" : () => {
                      switch(zoom){
                        case 6:
                          layerView.layer.definitionExpression = "RTE_PRFX='IH' AND MRKR_NBR LIKE '%25'"
                          break;
                        case 7:
                          layerView.layer.definitionExpression = "RTE_PRFX='IH' AND MRKR_NBR LIKE '%25'"
                          break;
                        case 8:
                          layerView.layer.definitionExpression = "RTE_PRFX='IH' AND MRKR_NBR LIKE '%25'"
                          break;
                        case 9:
                          layerView.layer.definitionExpression = "(RTE_PRFX='IH' AND (MRKR_NBR LIKE '%0')) or (RTE_PRFX='US' AND (MRKR_NBR LIKE '%0'))"
                          break;
                        case 10:
                          layerView.layer.definitionExpression = "(RTE_PRFX='IH' AND (MRKR_NBR LIKE '%0')) or (RTE_PRFX='US' AND (MRKR_NBR LIKE '%0'))"
                          break;
                        case 11:
                          layerView.layer.definitionExpression = "(RTE_PRFX='IH' AND (MRKR_NBR LIKE '%0' OR MRKR_NBR LIKE '%5')) or (RTE_PRFX='US' AND (MRKR_NBR LIKE '%0' OR MRKR_NBR LIKE '%5')) or (RTE_PRFX='SH' AND (MRKR_NBR LIKE '%0' OR MRKR_NBR LIKE '%5')) or (RTE_PRFX='SL' AND (MRKR_NBR LIKE '%0' OR MRKR_NBR LIKE '%5'))"
                          break;
                        case 12:
                          layerView.layer.definitionExpression = "(RTE_PRFX='IH' AND (MRKR_NBR LIKE '%0' OR MRKR_NBR LIKE '%5')) or (RTE_PRFX='US' AND (MRKR_NBR LIKE '%0' OR MRKR_NBR LIKE '%5')) or (RTE_PRFX='SH' AND (MRKR_NBR LIKE '%0' OR MRKR_NBR LIKE '%5')) or (RTE_PRFX='SL' AND (MRKR_NBR LIKE '%0' OR MRKR_NBR LIKE '%5'))"
                          break;
                        case 13:
                          layerView.layer.definitionExpression = ""
                          break;
                        default:
                          layerView.layer.definitionExpression = ""
                          break;
                        }

                    },
                    "Control Sections" : () => {
                      switch(zoom){
                        case 5:
                          layerView.layer.definitionExpression = "RTE_PRFX='IH'"
                          break;
                        case 6:
                          layerView.layer.definitionExpression = "RTE_PRFX='IH'"
                          break;
                        case 7:
                          layerView.layer.definitionExpression = "RTE_PRFX='IH'"
                          break;
                        case 8:
                          layerView.layer.definitionExpression = "(RTE_PRFX='IH' or RTE_PRFX='US')"
                          break;
                        case 9:
                          layerView.layer.definitionExpression = "(RTE_PRFX='IH' or RTE_PRFX='US')"
                          break;
                        case 10:
                          layerView.layer.definitionExpression = "(RTE_PRFX='IH' or RTE_PRFX='SH' or RTE_PRFX='US' or RTE_PRFX='SL')"
                          break;
                        case 11:
                          layerView.layer.definitionExpression = "RTE_PRFX NOT IN ('CS', 'FC', 'CR', 'FD', 'PR')"
                          break;
                        case 12:
                          layerView.layer.definitionExpression = "RTE_PRFX NOT IN ('CS', 'FC', 'CR', 'FD', 'PR')"
                          break;
                        case 13:
                          layerView.layer.definitionExpression = "RTE_PRFX <> 'CS'"
                          break;
                        default:
                          layerView.layer.definitionExpression = ""
                          break;
                        }
                    },
                    "Speed Limits" : () => {
                      switch(zoom){
                        case 6:
                          layerView.layer.definitionExpression = "RTE_PRFX ='IH' AND RDBD_TYPE = 'KG'"
                          break;
                        case 7:
                          layerView.layer.definitionExpression = "RTE_PRFX ='IH' AND RDBD_TYPE = 'KG'"
                          break;
                        case 8:
                          layerView.layer.definitionExpression = "RTE_PRFX ='IH' AND RDBD_TYPE = 'KG'"
                          break;
                        case 9:
                          layerView.layer.definitionExpression = "RTE_PRFX IN ('IH','US') AND RDBD_TYPE = 'KG'"
                          break;
                        case 10:
                          layerView.layer.definitionExpression = "RTE_PRFX IN ('IH','US') AND RDBD_TYPE = 'KG'"
                          break;
                        case 11:
                          layerView.layer.definitionExpression = "RTE_PRFX IN ('IH','SH','US','SL') AND RDBD_TYPE = 'KG'"
                          break;
                        case 12:
                          layerView.layer.definitionExpression = "RTE_PRFX IN ('IH','SH','US','SL') AND RDBD_TYPE = 'KG'"
                          break;
                        case 13:
                          layerView.layer.definitionExpression = ''
                          break;
                        default:
                          layerView.layer.definitionExpression = ''
                          break;
                        }
                    },
                    "Future Traffic & Percent Truck" : () => {
                      switch(zoom){
                        case 6:
                          layerView.layer.definitionExpression = "SUBSTRING(RIA_RTE_ID,1,2)='IH'"
                          break;
                        case 7:
                          layerView.layer.definitionExpression = "SUBSTRING(RIA_RTE_ID,1,2)='IH'"
                          break;
                        case 8:
                          layerView.layer.definitionExpression = "SUBSTRING(RIA_RTE_ID,1,2)='IH'"
                          break;
                        case 9:
                          layerView.layer.definitionExpression = "(SUBSTRING(RIA_RTE_ID,1,2)='IH' or SUBSTRING(RIA_RTE_ID,1,2)='US')"
                          break;
                        case 10:
                          layerView.layer.definitionExpression = "(SUBSTRING(RIA_RTE_ID,1,2)='IH' or SUBSTRING(RIA_RTE_ID,1,2)='US')"
                          break;
                        case 11:
                          layerView.layer.definitionExpression = "(SUBSTRING(RIA_RTE_ID,1,2)='IH' or SUBSTRING(RIA_RTE_ID,1,2)='US' or SUBSTRING(RIA_RTE_ID,1,2)='SH' or SUBSTRING(RIA_RTE_ID,1,2)='SL' or SUBSTRING(RIA_RTE_ID,1,2)='TL')"
                          break;
                        case 12:
                          layerView.layer.definitionExpression = "(SUBSTRING(RIA_RTE_ID,1,2)='IH' or SUBSTRING(RIA_RTE_ID,1,2)='US' or SUBSTRING(RIA_RTE_ID,1,2)='SH' or SUBSTRING(RIA_RTE_ID,1,2)='SL' or SUBSTRING(RIA_RTE_ID,1,2)='TL')"
                          break;
                        case 13:
                          layerView.layer.definitionExpression = ''
                          break;
                        default:
                          layerView.layer.definitionExpression = ''
                          break;
                        }
                    },
                    "Cemeteries" : () => {
                      switch(zoom){
                        case 6:
                          layerView.layer.definitionExpression = "Zoom <= 7"
                          break;
                        case 7:
                          layerView.layer.definitionExpression = "Zoom <= 7"
                          break;
                        case 8:
                          layerView.layer.definitionExpression = "Zoom <= 7"
                          break;
                        case 9:
                          layerView.layer.definitionExpression = "Zoom <= 10"
                          break;
                        case 10:
                          layerView.layer.definitionExpression = "Zoom <= 10"
                          break;
                        case 11:
                          layerView.layer.definitionExpression = "Zoom <= 16"
                          break;
                        case 12:
                          layerView.layer.definitionExpression = "Zoom <= 16"
                          break;
                        case 13:
                          layerView.layer.definitionExpression = "Zoom <= 16"
                          break;
                        default:
                          layerView.layer.definitionExpression = "Zoom <= 16"
                          break;
                        }
                    },

                  }
                  getItem[layerView.layer.name]()
                }
                  
              }

              async function basemapFeatureLayerActiveCheck(url, layerType){
                let alertTxt = "One or more layers are currently unavailable. We are aware of the problem and are working to fix it."
                let returnStatus = fetch(url)
                returnStatus
                  .then((x) => {
                    if(layerType === "featureLayer"){
                      return x.text()
                    }
                    let status = x.json()
                    return status
                    
                  })
                  .then((y) => {
                    if(layerType === "featureLayer"){
                      let status = false
                      errorArr = ["was not found"]
                      errorArr.forEach((errStr) =>{
                        if(!status){
                          status = y.includes(errStr) ? true : false 
                        }
                      })
                      status ? createServiceDown(alertTxt, "red") : null
                      return
                    }
                    if(!y.error){
                      loadBaseMaps(tileLayerTxDOT)
                      return 
                    }
                    if(y.error.code >= 404 && y.error.code <= 499){
                      createServiceDown(alertTxt, "red")
                      //turn on service down div
                      //backupTxdotLayer.visible = true
                      console.error("")
                      loadBaseMaps("https://tiles.arcgis.com/tiles/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Vector_Tile_Basemap_BACKUP/VectorTileServer")
                      return 
                    }
                  })
               
              }
              
              function createServiceDown(text, color, width){
                let serviceTemp = document.getElementById("serviceDown")
                let serviceTempClone = serviceTemp.content.cloneNode(true)
                let div = serviceTempClone.querySelectorAll("div")
                //div[1].classList.add("esri-icon-notice-triangle")
                div[1].textContent = text 
                div[1].style.backgroundColor = color
                document.body.appendChild(serviceTempClone)
              }

              function moveTable(){
                let routeTable = document.getElementById("results")
                var mousePosition;
                var offset = [0,0];
                var isDown = false;


                routeTable.addEventListener('mousedown', function(e) {
                    isDown = true;
                    offset = [
                    routeTable.offsetLeft - e.clientX,
                    routeTable.offsetTop - e.clientY
                    ];
                }, true);

                document.addEventListener('mouseup', function() {
                    isDown = false;
                }, true);

                document.addEventListener('mousemove', function(event) {
                    event.preventDefault();
                    if (isDown) {
                        mousePosition = {
                    
                            x : event.clientX,
                            y : event.clientY
                    
                        };
                        routeTable.style.left = (mousePosition.x + offset[0]) + 'px';
                        routeTable.style.top  = (mousePosition.y + offset[1]) + 'px';
                    }
                }, true);
              }

              document.getElementById("about").addEventListener("click", ()=>{
                aboutModal()
                document.getElementById("closeAbout").addEventListener("click", ()=>{
                  removeQueryResponseUI();
                  appDetailsModal()
                })
                
                
              })

              function aboutModal(){
                let version = "5.0.3 Falkland Island"
                queryResponseUI({para: `
                  The Statewide Planning Map displays data in support of planning operations at TxDOT.
                  <br>
                  <br>
                  Although we try to update information as often as possible, we are not assuming any responsibility for any damages or inaccuracies if you rely on it.
                  <br>
                  <br>
                  We offer no warranty that this application is accurate or complete. The information shown is for informational purposes and may not have been prepared for or be suitable for legal, engineering, or surveying purposes.
                  <br>
                  <br>
                  It does not represent an on-the-ground survey and represents only the approximate relative location of property/administrative boundaries.
                  <br>
                  <br>
                  <b style="font-size:1.2rem">Resouces</b>
                  <br>
                  Download and explore TxDOT GIS Data
                  <br>
                  <a target="_blank" href="https://gis-txdot.opendata.arcgis.com/" style="color:#14375A"><u>Open Data Portal</u></a><br>
                  <a target="_blank" href="https://txdot.maps.arcgis.com/home/index.html" style="color:#14375A"><u>ArcGIS Online</u></a>
                  <br>
                  <br>
                  Explore TxDOT data and maps
                  <br>
                  <a target="_blank" href="https://www.txdot.gov/data-maps.html" style="color:#14375A"><u>https://www.txdot.gov/data-maps.html</u></a>
                  <br>
                  <br>
                  <b style="font-size:1.2rem">Contact Us</b>
                  <br>
                  <a target="_blank" href="mailto:TPP_GIS@txdot.gov" style="color:#14375A"><u>TPP_GIS@txdot.gov</u></a>
                  <br>
                  <br>
                  <a id="closeAbout">Version: ${version}</a>

                  `, header:"About the Statewide Planning Map"}, null, height="714px", width="473px")
              }

              function appDetailsModal(){
                
                let releaseNotes = ["Updated JS to ESRI 4.x", "Updated User Interface", "Updated Search to include Bridges", 
                                    "Updated Bridge Popups to include Bridge Report", 
                                    "Updated Roadway Inventory - On System and Reference Marker scale dependencies", "Updated Control Section Job in Search",
                                    `Added "Copy XY" button to Popup`, "Add Admin Alert Control"]
                let releaseNotesList="";
                releaseNotes.map(x => releaseNotesList += `<li>${x}</li>`)
                queryResponseUI({para: `
                      <ul>
                        ${releaseNotesList}
                      </ul>
                  `, header: "Release Notes"}, null, height="300px", width="473px")
              }
            // end require - - -        
            });      
        </script>
    </head>
    <body class="main">
        <div id="header">
            <div class="logo">&nbsp;&nbsp;TxDOT - Statewide Planning Map</div>
            <nav>
                <a class="links" target="_blank" title="View the Planning Map Help Document" href="https://storymaps.arcgis.com/stories/3dfe9b5f84734e14a7da4dfbc77833b5">Help</a>
                <a class="links" id="about" target="_blank" title="About the Planning Map">About</a>
                <a class="links" href="mailto:tpp-gis@txdot.gov" title="Contact TPP-GIS">Contact</a>
                &nbsp;&nbsp;
            </nav>        
        </div>
        <div id="left-div">
            <div id="close"></div>
            <div id="tabsParent" class="tabsContainer">
                <div class="tabsChild" id="baseMaps" title="Base Maps and Overlays">Map</div>
                <div class="tabsChild" id="dataQuery" title="View Inventory Data">Query</div>
                <div class="tabsChild" id="eventForm" title="Add Lines to the Map">Event</div>                
                <div class="tabsChild" id="roadwayDiagram" title="Create a Simplified Roadway Diagram">SRD</div>                
                <div class="tabsChild" id="graphicSketch" title="Sketch a Route and Estimate Costs">Plan</div>
            </div>
            <div class="tocTabs" id="mapTab">
        			<table id="tocMaps">
        			<tr><th class="basemapHeader">Basemaps</th></tr>
        			<tr><td class="baseMapList" id='txdot'>TxDOT</td></tr>
        			<tr><td class="baseMapList" id='lightgray'>TxDOT Light Gray</td></tr>
        			<tr><td class="baseMapList" id='darkgray'>TxDOT Dark Gray</td></tr>
        			<tr><td class="baseMapList" id='imagery'>Texas Imagery Service</td></tr>        			
        			<tr><td class="baseMapList" id='esristreets'>Esri Streets</td></tr>
        			<tr><td class="baseMapList" id='osm'>Open Street Map</td></tr>
              <tr><th class="basemapHeader clearOverlay">Common Overlays</th></tr>
              
        			
              
        			<!-- <tr><td id='AADT'>AADT</td></tr>
			        <tr><td id='Control_Section'>Control Sections</td></tr>        			
        			<tr><td id='TxDOT_Projects'>TxDOT Projects</td></tr> -->
        			</table>
            </div>
            <div class="tocTabsQuery" id="queryTab">
              <form onsubmit="return false" name="errorQuery">
                <p class="borderLine"></p>
                <span class="stepClass underline" style="position: relative; top: -0.3rem; margin-bottom: .3rem;">Note about the Query form</span>
                <span class="tabDesc">Query and view inventory data.</span>
                <div id="querySelectionFilter" style="position: relative; bottom: 1rem;">
                  <span class="stepClass underline" style="position: relative; top: 0.7rem;">Select Layer</span>
                  <div style="position: relative; top: 1rem; right: .4rem; font-size: 13px;">
                    <input type="radio" id="RoadInventory" class="noDisabled" name="featQuery" value="RoadInventory" 
                    <label for="RoadInventory" value="Roadway Query"><a href="https://gis-txdot.opendata.arcgis.com/datasets/txdot-roadway-inventory-specifications-2021" target="_blank" title="Roadway Inventory Data Dictionary">Roadway Query</a></label>
                    <input id="Bridges" class="noDisabled" type="radio" name="featQuery" value="Bridges">
                    <label for="Bridges" value="Bridge Query"><a href='https://txdot.maps.arcgis.com/sharing/rest/content/items/e9d8d0e3a9794be19be6ecaf5a24c176/data' target='_blank' title="Bridge Data Dictionary">Bridge Query</a></label>
                  </div>
                </div>
                <span class="stepClass underline" style="position: relative; top: 0rem;">Build Query</span>
                <select id="field" class="spmDropDown a noDisabled1"></select>
                <select id="operator" class="spmDropDown a noDisabled1">
                    <option value="" selected>Select an Operator</option>
                    <option value="=">Equals</option>
                    <option value="<>">Does not equal</option>
                    <option value="<">Less than</option>
                    <option value=">">Greater than</option>
                    <option value="<=">Less than or equal to</option>
                    <option value=">=">Greater than or equal to</option>
                    <!--<option value="LIKE">LIKE (use % as a wildcard)</option>-->
                </select>
                <input type="text" id="value" class="noDisabled1" placeholder="Enter a value to query" disabled>
                <button class="queryButtonClass noDisabled1 spmMainBtn btnAddCondition qryBtn" id="btnAddCondition">Add Condition</button>
                <!-- <section><p id="fieldBuilder" class="queryBuilder">i.e EMP</p><p id="operatorBuilder" class="queryBuilder">i.e ></p><p id="valueBuilder" class="queryBuilder">i.e 1244</p></section> -->
                <ul id="conditions" class="noDisabled1 tableBtn">
                  <!-- <li>Conditions listed here</li> -->
                </ul><br>
                <span class="stepClass underline" style="position: relative; top: 0.4rem; margin-bottom: .4rem;">Select Output Fields</span>
                <select id="outputFields" multiple size="10" class="spmDropDown noDisabled1" disabled></select>
                
                <button class="queryButtonClass tableBtn spmMainBtn qryBtn" id="btnRunQuery">Run Query</button>

                <div class="classRowDiv">
                  <button class="queryButtonClass tableBtn spmSecondaryBtn qryBtn btnClearConditions clearBtn" id="btnClearConditions">Clear</button>  
                  <button class="queryButtonClass spmSecondaryBtn qryBtn" id="btnToggleTableView" disabled>Show Table</button>
                </div>

                <span class="stepClass underline" style="position: relative; top: 0.3rem; margin-bottom: .4rem;">Options</span>
                
                <div class="classRowDiv">
                  <button class="queryButtonClass spmSecondaryBtn qryBtn exportBtn" id="btnExportToCSV"><span class="esri-icon-link-external esriIcons" ></span>Export CSV</button>
                  <button id="btnQueryGenerateURL" class=" queryButtonClass spmSecondaryBtn qryBtn btnQueryGenerateURL exportBtn"><span class="esri-icon-share esriIcons"></span>Share URL</button>
                </div>
                
                
                
                <template id="queryTemplate">
                  <div>
                    <!-- <h1 style="position:relative; color:white; background-color: #14375A; height: 2rem; bottom: 1.7rem; width: 22.1rem; right:0.6rem; text-align: left; padding-top: .4rem; padding-left: 1rem;">Query Message</h1> -->
                  </div>
                </template>
                <span class="error" id="errorQuery"></span> 
              </form>          
            </div>
            <div class="tocTabsDiagram" id="diagramTab">
              <form onsubmit="return false" name="errorSrd">
                <p class="borderLine"></p>
                <span class="stepClass underline" style="position: relative; top: -0.3rem; margin-bottom: .3rem;">Note about the Diagram form</span>
                <span class="tabDesc">Display roadway attributes on a diagram.</span>
                <span class="stepClass underline" style="position: relative; top: -0.3rem; margin-bottom: .4rem;">Add Route</span>
                <input id="inpSRDRouteID"  type="text" placeholder="Route ID - Example: US0290-KG">
                <input id="inpSRDFromDFO"  step="0.001" type="number" class="noDisabled1 inputSRD" placeholder="Begin Measure - Example: 15" disabled>
                <input id="inpSRDToDFO"  step="0.001" type="number" class="noDisabled1 inputSRD" placeholder="End Measure - Example: 20" disabled>
                <!-- <span class="stepClass" style="position: relative; top: -0.3rem; margin-bottom: .4rem;">Step 2: Add Control Sections to Diagram</span> -->
                <button id="btnUpdateLRM" class="queryButtonClass srdBtn spmMainBtn btnAddCondition" disabled>Create Diagram</button>
                <span class="stepClass underline" style="position: relative; top: 0.1rem; margin-bottom: .4rem;" disabled>Add Additional Attributes</span>
                <select id="riAttributes" name="riAttribute" class="spmDropDown noDisabled1" disabled>
                    TxDOT_Base_Thickness
                    <option value="" selected>Select an Attribute</option>
                    <option value="TxDOT_AADT_SRD,AADT_CUR,AADT">Annual Average Daily Traffic 2021</option>
                    <option value="TxDOT_Route_City_SRD,CITY_NM,City Limit">City</option>                    
                    <option value="TxDOT_Route_County_SRD,CNTY_NM,County">County</option>
                    <option value="TxDOT_Route_District_SRD,DIST_NM,District">District</option>
                    <option value="TxDOT_Functional_Classification_SRD,FC_DESC,Functional System">Functional System</option>
                    <option value="TxDOT_Median_Width_SRD,MDN_WIDTH,Median Width">Median Width</option>
                    <option value="TxDOT_Number_of_Through_Lanes_SRD,LANE_CNT,Number of Lanes">Number of Lanes</option> 
                    <option value="TxDOT_Truck_Percent_SRD,TRK_PCT,Percent Truck">Percent Truck 2021</option>
                    <option value="TxDOT_Reference_Markers_SRD,MRKR_NBR,Reference Markers">Reference Markers</option>
                    <option value="TxDOT_Roadbed_Base_SRD,BASE_TYPE_DSCR,Roadbed Base">Roadbed Base</option>
                    <option value="TxDOT_Base_Thickness_SRD,BASE_THCK,Base Thickness">Roadbed Base Thickness</option>
                    <option value="TxDOT_Roadbed_Width_SRD,RDBD_WIDTH,Roadbed Width">Roadbed Width</option>
                    <option value="TxDOT_Minimum_Right_of_Way_Width_SRD,ROW_WIDTH,ROW Width">ROW Width (minimum)</option>
                    <option value="TxDOT_Inside_Shoulder_Width_SRD,WIDTH,Shoulder Width Inside">Shoulder Width Inside</option>
                    <option value="TxDOT_Outside_Shoulder_Width_SRD,WIDTH,Shoulder Width Outside">Shoulder Width Outside</option>                    
                    <option value="TxDOT_Speed_Limits_SRD,SPD_LMT,Speed Limit">Speed Limit</option>
                    <option value="TxDOT_Roadbed_Surface_SRD,SRFC_TYPE,Surface Type">Surface Type</option>                    
                </select>

                 
                <button id="btnInventoryUpdateLRM" class="queryButtonClass srdBtn spmMainBtn btnRunOpt">Add Attribute</button>
                <button id="btnRemoveLast" class="queryButtonClass spmMainBtn" disabled>Remove Last</button>
                <div class="classRowDiv">
                  <button id="btnClearDiagramView" class="queryButtonClass srdBtn spmSecondaryBtn btnClearConditions clearBtn">Clear</button>
                  <button id="btnToggleDiagramView" class="queryButtonClass srdBtn spmSecondaryBtn btnToggleTableView">Show Diagram</button>
                </div>
                                
                <span class="stepClass underline" style="position: relative; top: 0.6rem; margin-bottom: .4rem;">Options</span>

                <div class="classRowDiv">
                  <button id="btnExportPNG" class="queryButtonClass srdBtn spmSecondaryBtn exportBtn"><span class="esri-icon-link-external esriIcons"></span>Export PNG</button>
                  <button id="btnExportJPEG" class="queryButtonClass srdBtn spmSecondaryBtn exportBtn"><span class="esri-icon-link-external esriIcons"></span>Export JPEG</button> 
                  <button id="btnDiagramGenerateURL" class="queryButtonClass srdBtn spmSecondaryBtn exportBtn btnQueryGenerateURL"><span class="esri-icon-share esriIcons"></span>Share URL</button>
                </div>
                
                <span class="error" id="errorSrd"></span>
              </form>                
            </div>
            <div class="tocTabsEvent" id="eventTab">
              <form onsubmit="return false" name="errorEvent">
                <p class="borderLine"></p>
                <span class="stepClass underline" style="position: relative; top: -0.3rem; margin-bottom: .3rem;">Note about the Event form</span>
                <span class="tabDesc">Create and export roadway segments.</span>
                <span class="stepClass underline" style="position: relative; top: -0.3rem; margin-bottom: .4rem;">Add Route</span>
                <input type="text" id="eventRoute" placeholder="Route ID - Example: US0290-KG" name="RTE_NM"/>
                <input type="number" step="0.001" id="eventBeginDFO" class="noDisabled1 eventDisable" name="BDFO" placeholder="Begin Measure - Example: 15.123" min="0" max="1000" disabled/>
                <input disabled type="number" step="0.001" id="eventEndDFO" class="noDisabled1 eventDisable" name="EDFO" placeholder="End Measure - Example: 20.123" min="0" max="1000"/>
                <span class="stepClass underline" style="position: relative; top: -0.1rem; margin-bottom: .4rem;">Customize</span>
                <select id="eventColors" name="Color" class="spmDropDown noDisabled1 eventDisable" disabled>
                    <option value="">Select a Color</option>
                    <option value="#000000" selected>Black</option>
                    <option value="#cc6600">Brown</option>
                    <option value="#009933">Green</option>
                    <option value="#00bfff">Light Blue</option>
                    <option value="#ff00ff">Magenta</option>
                    <option value="#ff8000">Orange</option>
                    <option value="#ff0000">Red</option>
                    <option value="#14375a">TxDOT Blue</option>
                    <option value="#ffff00">Yellow</option>
                  </select>
                <input type="number" id="eventWidth" class="noDisabled1 eventDisable" name="Width" placeholder="Line Width - Example: 4" min="1" max="8" disabled/>
                <input type="text" id="eventDescription" class="noDisabled1" placeholder="Description for the Pop-Up" name="Desc" disabled/>
                
                <button id="btnRemoveAll" class="queryButtonClass eventBtn spmSecondaryBtn btnClearConditions clearBtn">Clear</button>
                <button id="btnEventMap" class="queryButtonClass eventBtn spmMainBtn btnRunOpt">Add to Map</button>  
                <!-- <button id="btnRemoveLast" class="queryButtonClass eventBtn spmSecondaryBtn btnToggleTableView">Remove Last</button> -->
                <!-- <span style="font-size: 14px; justify-content: left; position: relative; display: flex; bottom: 1rem;">Graphics Added to Map:</span> -->
                <div id="graphics"></div>
                <span class="stepClass underline" style="position: relative; top: -0.1rem; margin-bottom: .4rem; margin-top:1rem;">Options</span>
                <div class="classRowDiv">
                                   
                  <button id="btnGenerateURL" class="queryButtonClass eventBtn spmSecondaryBtn btnQueryGenerateURL exportBtn"><span class="esri-icon-share esriIcons"></span>Share URL</button>
                  <button id="btnExportToKML" class="queryButtonClass eventBtn spmSecondaryBtn exportBtn"><span class="esri-icon-link-external esriIcons" ></span>Export KML</button>
                </div>
                
                <span class="error" id="errorEvent"></span>
              </form>                 
            </div>            
            <div class="tocTabsSketch" id="sketchTab">
              <p class="borderLine"></p>
              <span class="stepClass underline" style="position: relative; top: -0.3rem; margin-bottom: .3rem;">Note about the Planning form</span>
              <span class="tabDesc">Sketch a road to estimate costs.</span>
              <div id="sketchContents">
                <p style="font-size: 13px; position: relative; bottom: 1rem; margin-top: 1.2rem;">* This tool is for planning purposes.  
                  It is not a tool for roadway design or engineering purposes.<br><br>
                  Construction cost estimates are calculated using average project cost by type from August 2003 to August 2013 in 2013 dollars.<br><br>
                  Frontage roads assumed two lanes per direction when selected.</p>
      					<br><br>
                <span class="stepClass underline" style="position: relative; top: -4rem; margin-bottom: -3.8rem;">Adjust Design</span>
                <label style="font-size: 13px;">Project Type</label>
    						<select id="selPrjType" name="selPrjType" class="spmDropDown">
    							<option value="A">New Roadway</option>
    							<option value="B">Reconstruction</option>
    						</select>
    						<br>
                <label style="font-size: 13px;">Area Type</label>
    						<select id="selPrjAreaType" name="selPrjAreaType" class="spmDropDown">
    							<option value="C">Urban</option>
    							<option value="D">Rural</option>
    						</select>
    						<br>
                <label style="font-size: 13px;">Route Type</label>
    						<select id="selPrjRouteType" name="selPrjRouteType" class="spmDropDown">
    							<option value="E">Freeway</option>
    							<option value="F">Arterial</option>
    							<option value="G">Collector</option>
    						</select>
    						<br>
                <label style="font-size: 13px;">Configuration</label>
    						<select id="selPrjDividedType" name="selPrjDividedType" class="spmDropDown">
    							<option value="H">Divided</option>
    							<option value="I">Undivided</option>
    						</select>
    						<br>
                <label style="font-size: 13px;">Frontage Roads</label>
    						<select id="selPrjFrontageRoads" name="selPrjFrontageRoads" class="spmDropDown">
    							<option value="1">No</option>
    							<option value="2">Yes</option>
    						</select>
    						<br>
                <!-- <button id="startDrawing" class="spmMainBtn">Start Drawing</button> -->
    						<!-- <span class="stepClass" style="position: relative; top: 0.7rem; margin-bottom: .4rem;">Step 2: Draw on Map</span> -->
                <label style="font-size: 13px;">Number of Main Lanes</label>
                <input type="number" value=4 id="txtPrjLanes" placeholder="Number of Lanes - Example: 4" name="txtPrjLanes">
                <br>
                <button id="btnClearProject" class="queryButtonClass spmMainBtn" title="Clear Project" disabled>Clear</button>
                <button id="btnRecalcProject" class="queryButtonClass spmMainBtn" title="Re-Calculate Project" disabled>Re-Calculate</button>
                <span class="stepClass underline">Results</span>
    						<div id="deCostResult"></div>      					
              </div>
            </div>            
        </div>
        <div id="viewDiv">
            <!--Map Tools-->
            <div id="toolsParent" class="toolsContainer">
                <div class="toolsChild esri-icon-measure" id="measureButton" title="Measure"></div>
                <div class="toolsChild esri-icon-map-pin" id="lrsButton" title="LRS Identify"></div>
                <div class="toolsChild esri-icon-applications" id="googleMaps" title="Jump to Google"></div>
                <div class="toolsChild esri-icon-printer" id="print" title="Print Map"></div>
                <div class="toolsChild esri-icon-layer-list" id="legend" title="View Legend"></div>
            </div>   
            <div id="marginal">
              <span id="zoom"></span>
              <span id="coords"></span>
            <!--Map coordinates and scale bar-->
            </div>
            <div id="mapClickResults">
            <!--Measure and LRS results, Legend-->
            </div>     
            <div id="searchTool" title="Search Tool" class="esri-icon-search toolsChild"></div>
            <div id="searchBox"></div>
            <div id="resetMap" class="toolsChild" title="Clear and reset map">&#x21BB;</div>
            <button class="hamburgler toolsChild esri-icon-drag-horizontal"></button>
            <div id="results">Build a query and view the results here...</div>
            <div id="parentCanvas">
    			      <canvas id="myCanvas">
                    <!--custom graphics here-->
                </canvas>
            </div>  
            <template id="serviceDown">
              <div class="esri-icon-notice-triangle" >
                <div id="serviceDownDiv"></div>
              </div>
            </template>
            <div id="expandPopup"></div>          
        </div>
    </body>
</html>